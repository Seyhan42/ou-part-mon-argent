<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Test gratuit â€” OÃ¹ part mon argent ?</title>
  <meta name="description" content="Test gratuit : estimez votre minimum vital et votre reste Ã  vivre en 2 minutes.">
  <link rel="stylesheet" href="css/style.css?v=2">
</head>
<body>

<header class="header">
  <div class="brand">
    <div class="logo">â‚¬</div>
    <div>
      <div class="brand-title">OÃ¹ part mon argent ?</div>
      <div class="brand-subtitle">Test gratuit</div>
    </div>
  </div>

  <nav class="nav">
    <a class="nav-link" href="index.html">Accueil</a>
    <a class="nav-link active" href="test.html">Test gratuit</a>
    <a class="nav-link" href="tarifs.html">Tarifs</a>
    <a class="nav-link" href="login.html" data-auth="out">Connexion</a>
    <a class="nav-link" href="dashboard.html" data-auth="in">Dashboard</a>
    <button class="btn-ghost" type="button" data-auth="in" data-logout>DÃ©connexion</button>
  </nav>
</header>

<main class="container">
  <div class="test-container">
    <section class="card">
      <h1>Test gratuit</h1>
      <p class="lead">
        Entrez des montants approximatifs pour obtenir une estimation de votre
        <strong>minimum vital</strong> et de votre <strong>reste Ã  vivre</strong>.
      </p>

      <form class="form" id="freeTestForm">
        <div class="form-row">
          <div class="field">
            <label for="income">Revenu mensuel net (â‚¬)</label>
            <input id="income" name="income" type="number" min="0" step="1" placeholder="Ex : 1800" required>
          </div>
          <div class="field">
            <label for="rent">Logement / loyer (â‚¬)</label>
            <input id="rent" name="rent" type="number" min="0" step="1" placeholder="Ex : 650" required>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label for="fixed">Charges fixes (internet, assurancesâ€¦) (â‚¬)</label>
            <input id="fixed" name="fixed" type="number" min="0" step="1" placeholder="Ex : 220" required>
          </div>
          <div class="field">
            <label for="variable">Courses + transport (estimation) (â‚¬)</label>
            <input id="variable" name="variable" type="number" min="0" step="1" placeholder="Ex : 450" required>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label for="subs">Abonnements (Netflix, telâ€¦) (â‚¬) <span class="muted">(optionnel)</span></label>
            <input id="subs" name="subs" type="number" min="0" step="1" placeholder="Ex : 40">
          </div>
          <div class="field">
            <label for="risk">Jeux d'argent / casino (â‚¬) <span class="muted">(optionnel)</span></label>
            <input id="risk" name="risk" type="number" min="0" step="1" placeholder="Ex : 0">
          </div>
        </div>

        <button class="btn btn-primary" type="submit">Calculer</button>

        <p class="hint" data-auth="out">
          Ce test ne sauvegarde rien. Pour un tableau de bord + suivi + rappels email, crÃ©ez un compte ensuite.
        </p>
        <p class="hint" data-auth="in" style="display: none;">
          âœ… ConnectÃ© ! Vos rÃ©sultats seront automatiquement sauvegardÃ©s dans votre Dashboard.
        </p>
      </form>

      <div class="divider"></div>

      <section id="result" class="result-box" style="display:none;">
        <h2>Votre estimation</h2>

        <div class="mini-grid">
          <div class="mini-card">
            <div class="mini-title">Minimum vital (mois)</div>
            <div class="mini-value" id="outMinMonth">â€”</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Minimum vital (semaine)</div>
            <div class="mini-value" id="outMinWeek">â€”</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Reste Ã  vivre (mois)</div>
            <div class="mini-value" id="outLeftMonth">â€”</div>
          </div>
        </div>

        <!-- Score (nouveau) -->
        <div style="text-align: center; margin: var(--space-xl) 0;">
          <div style="position: relative; width: 100px; height: 100px; margin: 0 auto;">
            <svg width="100" height="100" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="40" fill="none" stroke="#e5e7eb" stroke-width="8"/>
              <circle id="score-circle" cx="50" cy="50" r="40" fill="none" stroke="var(--accent)" stroke-width="8" 
                stroke-dasharray="251" stroke-dashoffset="251" stroke-linecap="round" 
                transform="rotate(-90 50 50)" style="transition: stroke-dashoffset 1s ease;"/>
            </svg>
            <div style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;">
              <span style="font-size: 24px; font-weight: 800;" id="score-value">0</span>
              <span style="font-size: 10px; color: var(--text-muted);">/100</span>
            </div>
          </div>
          <div style="margin-top: var(--space-sm);">
            <span class="badge" id="score-badge" style="font-size: 12px;">â€”</span>
          </div>
        </div>

        <div class="card mt-md" style="background: var(--bg-subtle); border: 1px solid var(--border-light);">
          <div class="mini-title">Lecture rapide</div>
          <p style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 8px 0;" id="outMessage">â€”</p>
          <p class="muted small" id="outTip"></p>
        </div>

        <!-- Message de sauvegarde pour les connectÃ©s -->
        <div class="card mt-md" id="saved-message" style="display: none; background: rgba(13,159,111,0.1); border: 1px solid var(--accent);">
          <p style="color: var(--accent); font-weight: 600; margin: 0;">
            âœ… RÃ©sultats sauvegardÃ©s dans votre Dashboard !
          </p>
        </div>

        <div class="cta-row mt-lg">
          <!-- Si connectÃ© -->
          <a class="btn btn-primary" href="dashboard.html" data-auth="in">ðŸ“Š Voir mon Dashboard</a>
          
          <!-- Si pas connectÃ© -->
          <a class="btn btn-primary" href="login.html" data-auth="out">CrÃ©er un compte</a>
          <a class="btn btn-secondary" href="tarifs.html" data-auth="out">Voir les offres</a>
        </div>
      </section>
    </section>
  </div>
</main>

<footer class="footer">
  <a href="tarifs.html">Tarifs</a> Â·
  <a href="index.html">Accueil</a> Â·
  <span class="muted">Â© <span id="year"></span> OÃ¹ part mon argent</span>
</footer>

<script src="assets/nav-auth.js"></script>
<script>
  // ============================================
  // CONFIGURATION
  // ============================================
  document.getElementById("year").textContent = new Date().getFullYear();
  
  const eur = (n) => new Intl.NumberFormat("fr-FR", { style: "currency", currency: "EUR" }).format(n);
  const WEEKS_PER_MONTH = 4.33;

  // ============================================
  // UTILITAIRES
  // ============================================
  function toNumber(id) {
    const v = document.getElementById(id).value;
    if (v === "" || v === null || v === undefined) return 0;
    const n = Number(v);
    return Number.isFinite(n) && n >= 0 ? n : 0;
  }

  function clamp(n) {
    return Number.isFinite(n) ? n : 0;
  }

  function isLoggedIn() {
    try {
      const s = JSON.parse(localStorage.getItem("auth_session_v1"));
      return !!(s && s.email);
    } catch { 
      return false; 
    }
  }

  // ============================================
  // CALCUL DU SCORE
  // ============================================
  function calculateScore(revenus, resteAVivre) {
    if (revenus <= 0) return 0;
    const ratio = resteAVivre / revenus;
    if (ratio >= 0.25) return Math.min(100, Math.round(70 + ratio * 100));
    if (ratio >= 0.10) return Math.round(40 + ratio * 200);
    if (ratio > 0) return Math.max(10, Math.round(ratio * 400));
    return 0;
  }

  function getScoreInfo(score) {
    if (score >= 70) return { label: 'Bonne santÃ©', class: 'success' };
    if (score >= 40) return { label: 'Ã€ surveiller', class: 'warning' };
    return { label: 'Attention', class: 'danger' };
  }

  function generateConseil(score) {
    if (score >= 70) return 'Votre situation financiÃ¨re est saine. Continuez Ã  Ã©pargner rÃ©guliÃ¨rement.';
    if (score >= 40) return 'Quelques ajustements peuvent amÃ©liorer votre situation financiÃ¨re.';
    return 'Votre reste Ã  vivre est faible. Identifiez les dÃ©penses Ã  rÃ©duire en prioritÃ©.';
  }

  // ============================================
  // SAUVEGARDE DANS LOCALSTORAGE
  // ============================================
  function saveTestToHistory(testData) {
    let tests = [];
    try {
      const stored = localStorage.getItem('tests');
      if (stored) tests = JSON.parse(stored);
    } catch (e) {}

    // Ajouter le nouveau test
    tests.push(testData);
    localStorage.setItem('tests', JSON.stringify(tests));

    // Mettre Ã  jour le dernier test
    localStorage.setItem('lastTest', JSON.stringify(testData));

    return testData;
  }

  // ============================================
  // ANIMATION DU SCORE
  // ============================================
  function animateScore(score) {
    const circumference = 2 * Math.PI * 40; // 251
    const offset = circumference - (score / 100) * circumference;
    
    setTimeout(() => {
      document.getElementById('score-circle').style.strokeDashoffset = offset;
    }, 200);

    // Animer le chiffre
    let current = 0;
    const duration = 1000;
    const start = performance.now();
    
    function step(timestamp) {
      const progress = Math.min((timestamp - start) / duration, 1);
      current = Math.floor(progress * score);
      document.getElementById('score-value').textContent = current;
      if (progress < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);

    // Badge
    const scoreInfo = getScoreInfo(score);
    const badge = document.getElementById('score-badge');
    badge.textContent = scoreInfo.label;
    badge.className = 'badge ' + scoreInfo.class;
  }

  // ============================================
  // SOUMISSION DU FORMULAIRE
  // ============================================
  document.getElementById("freeTestForm").addEventListener("submit", (e) => {
    e.preventDefault();

    // RÃ©cupÃ©rer les valeurs
    const income = toNumber("income");
    const rent = toNumber("rent");
    const fixed = toNumber("fixed");
    const variable = toNumber("variable");
    const subs = toNumber("subs");
    const risk = toNumber("risk");

    // Calculs
    const depensesEssentielles = clamp(rent + fixed + variable);
    const depensesNonEssentielles = clamp(subs + risk);
    const minMonth = clamp(depensesEssentielles + depensesNonEssentielles);
    const minWeek = clamp(minMonth / WEEKS_PER_MONTH);
    const leftMonth = clamp(income - minMonth);

    // Afficher les rÃ©sultats de base
    document.getElementById("outMinMonth").textContent = eur(minMonth);
    document.getElementById("outMinWeek").textContent = eur(minWeek);
    document.getElementById("outLeftMonth").textContent = eur(leftMonth);

    // Calculer le score
    const score = calculateScore(income, leftMonth);
    animateScore(score);

    // Message et conseils
    let message = "";
    let tip = "";

    if (income === 0) {
      message = "Entrez un revenu pour obtenir une estimation fiable.";
      tip = "Si vous n'avez pas de revenu fixe, mettez une moyenne mensuelle.";
    } else if (leftMonth < 0) {
      message = "ðŸ”´ Vous dÃ©pensez plus que votre revenu (dÃ©ficit).";
      tip = "La prioritÃ© : rÃ©duire abonnements/risques et ajuster les variables (courses/transport) dÃ¨s cette semaine.";
    } else if (leftMonth < income * 0.10) {
      message = "ðŸŸ  Vous avez peu de marge (reste Ã  vivre faible).";
      tip = "Objectif : remonter votre marge Ã  10â€“15% du revenu (petites coupes rÃ©guliÃ¨res).";
    } else {
      message = "ðŸŸ¢ Vous avez une marge correcte. Vous pouvez structurer une Ã©pargne.";
      tip = "Fixez un objectif (ex : voiture 10 000 â‚¬) et mettez en place un montant par semaine.";
    }

    const leaks = subs + risk;
    if (leaks >= 50) {
      tip += ` (Info : vos postes "abonnements/risque" totalisent ${eur(leaks)} / mois.)`;
    }

    document.getElementById("outMessage").textContent = message;
    document.getElementById("outTip").textContent = tip;

    // ============================================
    // SAUVEGARDE SI CONNECTÃ‰
    // ============================================
    if (isLoggedIn()) {
      const testData = {
        date: new Date().toISOString(),
        revenus: income,
        depensesEssentielles: depensesEssentielles,
        depensesNonEssentielles: depensesNonEssentielles,
        resteAVivre: leftMonth,
        score: score,
        conseil: generateConseil(score)
      };

      saveTestToHistory(testData);

      // Afficher le message de sauvegarde
      document.getElementById("saved-message").style.display = "block";
    }

    // Afficher la section rÃ©sultats
    document.getElementById("result").style.display = "block";
    document.getElementById("result").scrollIntoView({ behavior: "smooth", block: "start" });
  });
</script>

</body>
</html>
