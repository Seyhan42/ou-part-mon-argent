<!DOCTYPE html>
<html lang="fr">
<head>
   <link rel="stylesheet" href="/css/style.css?v=2">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Test gratuit ‚Äî O√π part mon argent ?</title>
  <meta name="description" content="Test gratuit : estimez votre minimum vital et votre reste √† vivre en 2 minutes.">
  <link rel="stylesheet" href="css/style.css">
</head>
  <script src="/assets/nav-auth.js"></script>
<body>

<header class="header">
  <div class="brand">
    <div class="logo">‚Ç¨</div>
    <div>
      <div class="brand-title">O√π part mon argent ?</div>
      <div class="brand-subtitle">Test gratuit</div>
    </div>
  </div>

  <nav class="nav">
  <a class="nav-link" href="/index.html">Accueil</a>
  <a class="nav-link" href="/test.html">Test gratuit</a>
  <a class="nav-link" href="/tarifs.html">Tarifs</a>

  <!-- Visible si PAS connect√© -->
  <a class="nav-link" href="/login.html" data-auth="out">Connexion</a>

  <!-- Visible si connect√© -->
  <a class="nav-link" href="/dashboard.html" data-auth="in">Dashboard</a>
  <button class="btn-ghost" type="button" data-auth="in" data-logout>
    D√©connexion
  </button>
</nav>

</header>

<main class="container">
  <div class="test-container">
    <section class="card">
      <h1>Test gratuit</h1>
      <p class="lead">
        Entrez des montants approximatifs pour obtenir une estimation de votre
        <strong>minimum vital</strong> et de votre <strong>reste √† vivre</strong>.
      </p>

      <form class="form" id="freeTestForm">
        <div class="form-row">
          <div class="field">
            <label for="income">Revenu mensuel net (‚Ç¨)</label>
            <input id="income" name="income" type="number" min="0" step="1" placeholder="Ex : 1800" required>
          </div>
          <div class="field">
            <label for="rent">Logement / loyer (‚Ç¨)</label>
            <input id="rent" name="rent" type="number" min="0" step="1" placeholder="Ex : 650" required>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label for="fixed">Charges fixes (internet, assurances‚Ä¶) (‚Ç¨)</label>
            <input id="fixed" name="fixed" type="number" min="0" step="1" placeholder="Ex : 220" required>
          </div>
          <div class="field">
            <label for="variable">Courses + transport (estimation) (‚Ç¨)</label>
            <input id="variable" name="variable" type="number" min="0" step="1" placeholder="Ex : 450" required>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label for="subs">Abonnements (Netflix, tel‚Ä¶) (‚Ç¨) <span class="muted">(optionnel)</span></label>
            <input id="subs" name="subs" type="number" min="0" step="1" placeholder="Ex : 40">
          </div>
          <div class="field">
            <label for="risk">Jeux d'argent / casino (‚Ç¨) <span class="muted">(optionnel)</span></label>
            <input id="risk" name="risk" type="number" min="0" step="1" placeholder="Ex : 0">
          </div>
        </div>

        <button class="btn btn-primary" type="submit">Calculer</button>

        <p class="hint">
          Ce test ne sauvegarde rien. Pour un tableau de bord + suivi + rappels email, cr√©ez un compte ensuite.
        </p>
      </form>

      <div class="divider"></div>

      <section id="result" class="result-box" style="display:none;">
        <h2>Votre estimation</h2>

        <div class="mini-grid">
          <div class="mini-card">
            <div class="mini-title">Minimum vital (mois)</div>
            <div class="mini-value" id="outMinMonth">‚Äî</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Minimum vital (semaine)</div>
            <div class="mini-value" id="outMinWeek">‚Äî</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Reste √† vivre (mois)</div>
            <div class="mini-value" id="outLeftMonth">‚Äî</div>
          </div>
        </div>

        <div class="card mt-md" style="background: var(--bg-subtle); border: 1px solid var(--border-light);">
          <div class="mini-title">Lecture rapide</div>
          <p style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 8px 0;" id="outMessage">‚Äî</p>
          <p class="muted small" id="outTip"></p>
        </div>

        <div class="cta-row mt-lg">
          <a class="btn btn-primary" href="login.html">Cr√©er un compte</a>
          <a class="btn btn-secondary" href="tarifs.html">Voir les offres</a>
        </div>
      </section>
    </section>
  </div>
</main>

<footer class="footer">
  <span>¬© <span id="year"></span> O√π part mon argent</span>
</footer>

<script>
  document.getElementById("year").textContent = new Date().getFullYear();

  const eur = (n) => new Intl.NumberFormat("fr-FR", { style: "currency", currency: "EUR" }).format(n);
  const WEEKS_PER_MONTH = 4.33;

  function toNumber(id) {
    const v = document.getElementById(id).value;
    if (v === "" || v === null || v === undefined) return 0;
    const n = Number(v);
    return Number.isFinite(n) && n >= 0 ? n : 0;
  }

  function clamp(n) {
    return Number.isFinite(n) ? n : 0;
  }

  document.getElementById("freeTestForm").addEventListener("submit", (e) => {
    e.preventDefault();

    const income = toNumber("income");
    const rent = toNumber("rent");
    const fixed = toNumber("fixed");
    const variable = toNumber("variable");
    const subs = toNumber("subs");
    const risk = toNumber("risk");

    const minMonth = clamp(rent + fixed + variable + subs + risk);
    const minWeek = clamp(minMonth / WEEKS_PER_MONTH);
    const leftMonth = clamp(income - minMonth);

    document.getElementById("outMinMonth").textContent = eur(minMonth);
    document.getElementById("outMinWeek").textContent = eur(minWeek);
    document.getElementById("outLeftMonth").textContent = eur(leftMonth);

    let message = "";
    let tip = "";

    if (income === 0) {
      message = "Entrez un revenu pour obtenir une estimation fiable.";
      tip = "Si vous n'avez pas de revenu fixe, mettez une moyenne mensuelle.";
    } else if (leftMonth < 0) {
      message = "üî¥ Vous d√©pensez plus que votre revenu (d√©ficit).";
      tip = "La priorit√© : r√©duire abonnements/risques et ajuster les variables (courses/transport) d√®s cette semaine.";
    } else if (leftMonth < income * 0.10) {
      message = "üü† Vous avez peu de marge (reste √† vivre faible).";
      tip = "Objectif : remonter votre marge √† 10‚Äì15% du revenu (petites coupes r√©guli√®res).";
    } else {
      message = "üü¢ Vous avez une marge correcte. Vous pouvez structurer une √©pargne.";
      tip = "Fixez un objectif (ex : voiture 10 000 ‚Ç¨) et mettez en place un montant par semaine.";
    }

    const leaks = subs + risk;
    if (leaks >= 50) {
      tip += ` (Info : vos postes "abonnements/risque" totalisent ${eur(leaks)} / mois.)`;
    }

    document.getElementById("outMessage").textContent = message;
    document.getElementById("outTip").textContent = tip;

    document.getElementById("result").style.display = "block";
    document.getElementById("result").scrollIntoView({ behavior: "smooth", block: "start" });
  });
</script>
   // ============================================
// SNIPPET √Ä AJOUTER √Ä TEST.HTML
// √Ä placer apr√®s le calcul des r√©sultats
// ============================================

// Fonction pour sauvegarder le test dans localStorage
function saveTestToHistory(testData) {
  // R√©cup√©rer l'historique existant
  let tests = [];
  try {
    const stored = localStorage.getItem('tests');
    if (stored) tests = JSON.parse(stored);
  } catch (e) {}

  // Cr√©er l'objet test
  const newTest = {
    date: new Date().toISOString(),
    revenus: testData.revenus,
    depensesEssentielles: testData.depensesEssentielles,
    depensesNonEssentielles: testData.depensesNonEssentielles,
    resteAVivre: testData.resteAVivre,
    score: testData.score || calculateTestScore(testData),
    conseil: testData.conseil || ''
  };

  // Ajouter √† l'historique
  tests.push(newTest);
  localStorage.setItem('tests', JSON.stringify(tests));

  // Mettre √† jour le dernier test
  localStorage.setItem('lastTest', JSON.stringify(newTest));

  return newTest;
}

// Calcul du score bas√© sur le reste √† vivre
function calculateTestScore(data) {
  const ratio = data.resteAVivre / data.revenus;
  if (ratio >= 0.25) return Math.min(100, Math.round(70 + ratio * 100));
  if (ratio >= 0.10) return Math.round(40 + ratio * 200);
  return Math.max(0, Math.round(ratio * 400));
}

// G√©n√©rer un conseil bas√© sur le score
function generateConseil(score) {
  if (score >= 70) return 'Votre situation financi√®re est saine. Continuez √† √©pargner r√©guli√®rement pour atteindre vos objectifs.';
  if (score >= 40) return 'Quelques ajustements peuvent am√©liorer votre situation financi√®re. Identifiez les d√©penses non essentielles √† r√©duire.';
  return 'Votre reste √† vivre est faible. Identifiez les d√©penses √† r√©duire en priorit√© et √©tablissez un budget strict.';
}

// ============================================
// EXEMPLE D'UTILISATION
// √Ä adapter selon la structure de ton test.html
// ============================================

/*
// Quand l'utilisateur soumet le formulaire de test :

function onTestSubmit() {
  // R√©cup√©rer les valeurs du formulaire
  const revenus = parseFloat(document.getElementById('revenus').value) || 0;
  const depEss = parseFloat(document.getElementById('depenses-essentielles').value) || 0;
  const depNonEss = parseFloat(document.getElementById('depenses-non-essentielles').value) || 0;
  const resteAVivre = revenus - depEss - depNonEss;

  // Cr√©er l'objet test
  const testData = {
    revenus: revenus,
    depensesEssentielles: depEss,
    depensesNonEssentielles: depNonEss,
    resteAVivre: resteAVivre
  };

  // Calculer le score
  testData.score = calculateTestScore(testData);
  testData.conseil = generateConseil(testData.score);

  // Sauvegarder
  saveTestToHistory(testData);

  // Si connect√©, rediriger vers dashboard
  const isLoggedIn = (() => {
    try {
      const s = JSON.parse(localStorage.getItem("auth_session_v1"));
      return !!(s && s.email);
    } catch { return false; }
  })();

  if (isLoggedIn) {
    // Redirection vers le dashboard
    window.location.href = 'dashboard.html';
  } else {
    // Afficher les r√©sultats sur la page
    showResults(testData);
  }
}
*/

// ============================================
// VERSION COMPL√àTE - REMPLACE TON CODE TEST
// ============================================

// Si ton test.html utilise un formulaire, voici comment l'int√©grer :
// Ajoute ceci apr√®s ton <script> existant ou remplace la logique de calcul

document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  if (!form) return;

  form.addEventListener('submit', function(e) {
    e.preventDefault();

    // Adapter ces IDs selon ton formulaire
    const revenus = parseFloat(document.getElementById('revenus')?.value) || 0;
    
    // Si tu as des champs individuels pour les d√©penses
    // const loyer = parseFloat(document.getElementById('loyer')?.value) || 0;
    // const transport = parseFloat(document.getElementById('transport')?.value) || 0;
    // etc.

    // Exemple avec champs g√©n√©riques
    const depEss = parseFloat(document.getElementById('depenses-essentielles')?.value) || 0;
    const depNonEss = parseFloat(document.getElementById('depenses-non-essentielles')?.value) || 0;
    
    const resteAVivre = revenus - depEss - depNonEss;

    const testData = {
      revenus: revenus,
      depensesEssentielles: depEss,
      depensesNonEssentielles: depNonEss,
      resteAVivre: resteAVivre
    };

    testData.score = calculateTestScore(testData);
    testData.conseil = generateConseil(testData.score);

    // Sauvegarder
    saveTestToHistory(testData);

    // V√©rifier si connect√©
    let isLoggedIn = false;
    try {
      const s = JSON.parse(localStorage.getItem("auth_session_v1"));
      isLoggedIn = !!(s && s.email);
    } catch {}

    // Afficher r√©sultats ou rediriger
    if (isLoggedIn) {
      // Option 1: Rediriger vers dashboard
      // window.location.href = 'dashboard.html';
      
      // Option 2: Afficher r√©sultats puis proposer d'aller au dashboard
      // showResults(testData);
    }
  });
});

</body>
</html>
