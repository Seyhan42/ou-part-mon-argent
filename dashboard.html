<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard ‚Äì O√π part mon argent ?</title>
  <link rel="stylesheet" href="css/style.css?v=5">
  <style>
    .dashboard { max-width: 1000px; margin: 0 auto; padding: 24px 16px; }
    .tabs { display: flex; gap: 4px; background: #fff; padding: 4px; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 24px; }
    .tab { flex: 1; padding: 12px; border: none; background: transparent; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; color: #6b7280; }
    .tab:hover { background: #f3f4f6; color: #111827; }
    .tab.active { background: #0d9f6f; color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .plan-banner { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: linear-gradient(135deg, rgba(13,159,111,0.1), rgba(59,130,246,0.1)); border-radius: 12px; margin-bottom: 24px; border: 1px solid rgba(13,159,111,0.2); flex-wrap: wrap; gap: 16px; }
    .plan-info { display: flex; align-items: center; gap: 16px; }
    .plan-icon { font-size: 24px; }
    .plan-name { font-weight: 700; font-size: 18px; }
    .plan-desc { font-size: 14px; color: #6b7280; }
    .import-banner { background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; padding: 16px 24px; margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
    .score-section { text-align: center; padding: 24px; }
    .score-circle { position: relative; width: 140px; height: 140px; margin: 0 auto 16px; }
    .score-circle svg { transform: rotate(-90deg); }
    .score-circle-bg { fill: none; stroke: #e5e7eb; stroke-width: 12; }
    .score-circle-fill { fill: none; stroke: #0d9f6f; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 1s ease; }
    .score-value { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .score-number { font-size: 36px; font-weight: 800; }
    .score-label { font-size: 12px; color: #6b7280; }
    .missions { margin-top: 24px; }
    .mission { display: flex; align-items: center; gap: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px; margin-bottom: 8px; }
    .mission.completed { background: rgba(13,159,111,0.1); }
    .mission-check { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #d1d5db; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .mission.completed .mission-check { background: #0d9f6f; border-color: #0d9f6f; color: #fff; }
    .mission-text { flex: 1; font-size: 14px; }
    .mission-points { font-size: 12px; font-weight: 600; color: #0d9f6f; }
    .epargne-card { background: linear-gradient(135deg, #0d9f6f, #0b8a5e); color: #fff; border-radius: 12px; padding: 32px; margin-top: 24px; }
    .epargne-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px; }
    .epargne-title { font-size: 18px; font-weight: 700; }
    .epargne-progress { height: 12px; background: rgba(255,255,255,0.3); border-radius: 9999px; overflow: hidden; margin-bottom: 16px; }
    .epargne-progress-fill { height: 100%; background: #fff; border-radius: 9999px; transition: width 0.5s; }
    .epargne-stats { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
    .epargne-stat { text-align: center; flex: 1; min-width: 70px; }
    .epargne-stat-value { font-size: 20px; font-weight: 700; }
    .epargne-stat-label { opacity: 0.8; font-size: 11px; }
    .journal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .journal-filters { display: flex; gap: 8px; flex-wrap: wrap; }
    .filter-btn { padding: 6px 16px; border: 1px solid #e5e7eb; background: #fff; border-radius: 9999px; font-size: 12px; cursor: pointer; }
    .filter-btn:hover, .filter-btn.active { background: #0d9f6f; color: #fff; border-color: #0d9f6f; }
    .movement-list { display: flex; flex-direction: column; gap: 8px; }
    .movement { display: flex; align-items: center; gap: 12px; padding: 12px; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; }
    .movement-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .movement-icon.revenu { background: rgba(34,197,94,0.1); }
    .movement-icon.epargne { background: rgba(13,159,111,0.1); }
    .movement-icon.essentiel { background: rgba(59,130,246,0.1); }
    .movement-icon.non-essentiel { background: rgba(245,158,11,0.1); }
    .movement-icon.imprevu { background: rgba(220,38,38,0.1); }
    .movement-info { flex: 1; min-width: 0; }
    .movement-title { font-weight: 600; font-size: 14px; }
    .movement-meta { font-size: 12px; color: #6b7280; }
    .movement-amount { font-weight: 700; }
    .movement-amount.positive { color: #0d9f6f; }
    .movement-amount.negative { color: #dc2626; }
    .movement-delete { background: none; border: none; cursor: pointer; padding: 8px; font-size: 16px; }
    .empty-state { text-align: center; padding: 48px; color: #6b7280; }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
    .tool-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; margin-bottom: 24px; position: relative; }
    .tool-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
    .tool-icon { width: 48px; height: 48px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
    .tool-info { flex: 1; }
    .tool-title { font-size: 18px; font-weight: 700; }
    .tool-desc { font-size: 14px; color: #6b7280; }
    .tool-content { }
    .locked-tool .tool-content { filter: blur(3px); pointer-events: none; opacity: 0.5; }
    .locked-overlay { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; text-align: center; padding: 24px; background: rgba(255,255,255,0.95); border-radius: 12px; }
    .locked-tool .locked-overlay { display: flex; }
    .locked-icon { font-size: 48px; margin-bottom: 16px; }
    .locked-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; }
    .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .compare-box { padding: 24px; border-radius: 8px; }
    .compare-box.a { background: rgba(13,159,111,0.1); border: 2px solid #0d9f6f; }
    .compare-box.b { background: rgba(59,130,246,0.1); border: 2px solid #3b82f6; }
    .compare-label { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
    .compare-badge { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #fff; font-size: 14px; }
    .compare-badge.a { background: #0d9f6f; }
    .compare-badge.b { background: #3b82f6; }
    .compare-result { margin-top: 24px; padding: 24px; background: #f3f4f6; border-radius: 8px; text-align: center; display: none; }
    .prelevement { display: flex; align-items: center; gap: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px; margin-bottom: 8px; }
    .prelevement-date { width: 50px; text-align: center; }
    .prelevement-day { font-size: 20px; font-weight: 700; }
    .prelevement-month { font-size: 11px; color: #6b7280; }
    .prelevement-info { flex: 1; }
    .prelevement-name { font-weight: 600; }
    .prelevement-amount { font-weight: 700; color: #dc2626; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 16px; }
    .modal.open { display: flex; }
    .modal-content { background: #fff; border-radius: 16px; max-width: 450px; width: 100%; max-height: 90vh; overflow: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 24px; border-bottom: 1px solid #e5e7eb; }
    .modal-title { font-size: 18px; font-weight: 700; }
    .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #6b7280; line-height: 1; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 24px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end; }
    .type-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 24px; }
    .type-option { padding: 16px 8px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: center; }
    .type-option:hover { border-color: #0d9f6f; }
    .type-option.selected { border-color: #0d9f6f; background: rgba(13,159,111,0.1); }
    .type-option-icon { font-size: 24px; margin-bottom: 4px; }
    .type-option-label { font-size: 11px; font-weight: 600; }
    .chat-btn { position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #0d9f6f, #0b8a5e); color: #fff; border: none; cursor: pointer; font-size: 28px; box-shadow: 0 4px 20px rgba(13,159,111,0.4); z-index: 999; }
    .chat-window { position: fixed; bottom: 100px; right: 24px; width: 380px; max-width: calc(100vw - 48px); height: 500px; max-height: calc(100vh - 150px); background: #fff; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: none; flex-direction: column; z-index: 1000; }
    .chat-window.open { display: flex; }
    .chat-header { background: linear-gradient(135deg, #0d9f6f, #0b8a5e); color: #fff; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
    .chat-header-info { display: flex; align-items: center; gap: 10px; }
    .chat-close { background: rgba(255,255,255,0.2); border: none; color: #fff; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 20px; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; background: #f9fafb; }
    .chat-message { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; }
    .chat-message.bot { background: #fff; border: 1px solid #e5e7eb; align-self: flex-start; border-bottom-left-radius: 4px; }
    .chat-message.user { background: #0d9f6f; color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; }
    .chat-input-area { padding: 16px; background: #fff; border-top: 1px solid #e5e7eb; display: flex; gap: 8px; border-radius: 0 0 16px 16px; }
    .chat-input { flex: 1; padding: 10px 16px; border: 1px solid #e5e7eb; border-radius: 9999px; font-size: 14px; }
    .chat-input:focus { outline: none; border-color: #0d9f6f; }
    .chat-send { width: 44px; height: 44px; border-radius: 50%; background: #0d9f6f; color: #fff; border: none; cursor: pointer; font-size: 18px; }
    .chat-locked { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px; text-align: center; background: #f9fafb; }
    @media (max-width: 768px) {
      .tabs { flex-wrap: wrap; }
      .tab { flex: none; width: calc(33.33% - 4px); font-size: 12px; padding: 10px 8px; }
      .compare-grid { grid-template-columns: 1fr; }
      .type-selector { grid-template-columns: repeat(2, 1fr); }
      .chat-window { bottom: 0; right: 0; left: 0; width: 100%; max-width: 100%; height: 85vh; border-radius: 16px 16px 0 0; }
      .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr !important; }
    }
  </style>
</head>
<body>

<header class="header">
  <div class="brand">
    <div class="logo">‚Ç¨</div>
    <div>
      <div class="brand-title">O√π part mon argent ?</div>
      <div class="brand-subtitle">Clart√© ‚Ä¢ √âpargne ‚Ä¢ D√©cisions</div>
    </div>
  </div>
  <nav class="nav">
    <a class="nav-link" href="index.html">Accueil</a>
    <a class="nav-link" href="test.html">Test gratuit</a>
    <a class="nav-link" href="tarifs.html">Tarifs</a>
    <a class="nav-link" href="login.html" data-auth="out">Connexion</a>
    <a class="nav-link active" href="dashboard.html" data-auth="in">Dashboard</a>
    <button class="btn-ghost" type="button" data-auth="in" data-logout>D√©connexion</button>
  </nav>
</header>

<main class="dashboard">
  <!-- Import Banner -->
  <div class="import-banner" id="import-banner" style="display:none">
    <div style="display:flex;align-items:center;gap:12px">
      <span style="font-size:24px">üìä</span>
      <div>
        <strong>Test budg√©taire d√©tect√© !</strong>
        <div style="font-size:12px;color:#6b7280">Importez vos donn√©es dans le journal</div>
      </div>
    </div>
    <button class="btn btn-primary" onclick="importTest()">Importer le test</button>
  </div>

  <!-- Plan Banner -->
  <div class="plan-banner">
    <div class="plan-info">
      <div class="plan-icon" id="plan-icon">‚≠ê</div>
      <div>
        <div class="plan-name" id="plan-name">Plan Gratuit</div>
        <div class="plan-desc" id="plan-desc">Fonctionnalit√©s de base</div>
      </div>
    </div>
    <a href="tarifs.html" class="btn btn-ghost">Am√©liorer</a>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="showTab('apercu')">üìä Aper√ßu</button>
    <button class="tab" onclick="showTab('mouvements')">üìã Mouvements</button>
    <button class="tab" onclick="showTab('outils')">üõ†Ô∏è Outils</button>
  </div>

  <!-- APER√áU -->
  <div class="tab-content active" id="tab-apercu">
    <div class="grid-4" style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px">
      <div class="stat-card">
        <div class="stat-label">üíµ Revenus</div>
        <div class="stat-value" id="stat-revenus">0 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">üè† Essentielles</div>
        <div class="stat-value" id="stat-essentielles">0 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">üõçÔ∏è Non essentielles</div>
        <div class="stat-value" id="stat-non-essentielles">0 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">‚ú® Reste √† vivre</div>
        <div class="stat-value positive" id="stat-reste">0 ‚Ç¨</div>
      </div>
    </div>

    <div class="grid-2" style="display:grid;grid-template-columns:repeat(2,1fr);gap:24px">
      <div class="card">
        <h3 style="text-align:center">Score sant√© financi√®re</h3>
        <div class="score-section">
          <div class="score-circle">
            <svg width="140" height="140" viewBox="0 0 140 140">
              <circle class="score-circle-bg" cx="70" cy="70" r="60"/>
              <circle class="score-circle-fill" id="score-circle" cx="70" cy="70" r="60" stroke-dasharray="377" stroke-dashoffset="377"/>
            </svg>
            <div class="score-value">
              <div class="score-number" id="score-number">0</div>
              <div class="score-label">/ 100</div>
            </div>
          </div>
          <span class="badge" id="score-badge">‚Äî</span>
        </div>
      </div>

      <div class="card">
        <h3>üéØ Missions de la semaine</h3>
        <div class="missions" id="missions-list"></div>
        <div style="text-align:center;margin-top:16px">
          <span class="badge success" id="missions-progress">0/3</span>
        </div>
      </div>
    </div>

    <div class="epargne-card">
      <div class="epargne-header">
        <div>
          <div class="epargne-title">üíé Objectif √©pargne</div>
          <div id="epargne-objectif-text" style="font-size:14px;opacity:0.9">D√©finir un objectif</div>
        </div>
        <button class="btn btn-ghost" style="background:rgba(255,255,255,0.2);color:#fff;border:none" onclick="openModal('modal-epargne')">‚öôÔ∏è</button>
      </div>
      <div class="epargne-progress">
        <div class="epargne-progress-fill" id="epargne-progress" style="width:0%"></div>
      </div>
      <div class="epargne-stats">
        <div class="epargne-stat"><div class="epargne-stat-value" id="epargne-total">0 ‚Ç¨</div><div class="epargne-stat-label">Total √©pargn√©</div></div>
        <div class="epargne-stat"><div class="epargne-stat-value" id="epargne-mois">0 ‚Ç¨</div><div class="epargne-stat-label">Ce mois</div></div>
        <div class="epargne-stat"><div class="epargne-stat-value" id="epargne-restant">0 ‚Ç¨</div><div class="epargne-stat-label">Restant</div></div>
        <div class="epargne-stat"><div class="epargne-stat-value" id="epargne-conseille">0 ‚Ç¨</div><div class="epargne-stat-label">Conseill√©/mois</div></div>
      </div>
    </div>
  </div>

  <!-- MOUVEMENTS -->
  <div class="tab-content" id="tab-mouvements">
    <div class="journal-header">
      <div>
        <h2>üìã Journal des mouvements</h2>
        <p style="color:#6b7280;font-size:14px">Toutes vos entr√©es/sorties</p>
      </div>
      <button class="btn btn-primary" onclick="openModal('modal-movement')">+ Ajouter</button>
    </div>

    <div class="journal-filters">
      <button class="filter-btn active" onclick="filterMovements('all', this)">Tous</button>
      <button class="filter-btn" onclick="filterMovements('revenu', this)">üíµ Revenus</button>
      <button class="filter-btn" onclick="filterMovements('epargne', this)">üíé √âpargne</button>
      <button class="filter-btn" onclick="filterMovements('essentiel', this)">üè† Essentielles</button>
      <button class="filter-btn" onclick="filterMovements('non-essentiel', this)">üõçÔ∏è Non ess.</button>
      <button class="filter-btn" onclick="filterMovements('imprevu', this)">üö® Impr√©vus</button>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="movement-list" id="movement-list"></div>
    </div>

    <div class="card" style="margin-top:24px">
      <h3>üìä R√©sum√© du mois</h3>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px">
        <div style="text-align:center;padding:16px;background:rgba(13,159,111,0.1);border-radius:8px">
          <div style="font-size:24px;font-weight:700;color:#0d9f6f" id="resume-entrees">+0 ‚Ç¨</div>
          <div style="font-size:12px;color:#6b7280">Entr√©es</div>
        </div>
        <div style="text-align:center;padding:16px;background:rgba(220,38,38,0.1);border-radius:8px">
          <div style="font-size:24px;font-weight:700;color:#dc2626" id="resume-sorties">-0 ‚Ç¨</div>
          <div style="font-size:12px;color:#6b7280">Sorties</div>
        </div>
        <div style="text-align:center;padding:16px;background:#f3f4f6;border-radius:8px">
          <div style="font-size:24px;font-weight:700" id="resume-solde">0 ‚Ç¨</div>
          <div style="font-size:12px;color:#6b7280">Solde</div>
        </div>
      </div>
    </div>
  </div>

  <!-- OUTILS -->
  <div class="tab-content" id="tab-outils">
    <!-- Comparateur -->
    <div class="tool-card" id="tool-comparateur">
      <div class="tool-header">
        <div class="tool-icon">‚öñÔ∏è</div>
        <div class="tool-info">
          <div class="tool-title">Comparateur de d√©cisions</div>
          <div class="tool-desc">Comparez deux choix financiers</div>
        </div>
        <span class="badge pro" id="badge-comparateur">PRO</span>
      </div>
      <div class="tool-content">
        <div class="compare-grid">
          <div class="compare-box a">
            <div class="compare-label"><div class="compare-badge a">A</div><input type="text" id="compare-a-nom" placeholder="Choix A" style="border:none;background:transparent;font-weight:600;width:100%"></div>
            <div class="field"><label>Co√ªt mensuel (‚Ç¨)</label><input type="number" id="compare-a-cout" placeholder="0"></div>
            <div class="field" style="margin-top:8px"><label>Dur√©e (mois)</label><input type="number" id="compare-a-duree" placeholder="12"></div>
          </div>
          <div class="compare-box b">
            <div class="compare-label"><div class="compare-badge b">B</div><input type="text" id="compare-b-nom" placeholder="Choix B" style="border:none;background:transparent;font-weight:600;width:100%"></div>
            <div class="field"><label>Co√ªt mensuel (‚Ç¨)</label><input type="number" id="compare-b-cout" placeholder="0"></div>
            <div class="field" style="margin-top:8px"><label>Dur√©e (mois)</label><input type="number" id="compare-b-duree" placeholder="12"></div>
          </div>
        </div>
        <div style="text-align:center;margin-top:20px">
          <button class="btn btn-primary" onclick="comparer()">‚öñÔ∏è Comparer</button>
        </div>
        <div class="compare-result" id="compare-result"></div>
      </div>
      <div class="locked-overlay">
        <div class="locked-icon">üîí</div>
        <div class="locked-title">Plan Essentiel requis</div>
        <a href="tarifs.html" class="btn btn-primary">D√©bloquer</a>
      </div>
    </div>

    <!-- Simulateur -->
    <div class="tool-card" id="tool-simulateur">
      <div class="tool-header">
        <div class="tool-icon">üö®</div>
        <div class="tool-info">
          <div class="tool-title">Simulateur d'impr√©vu</div>
          <div class="tool-desc">Testez la r√©sistance de votre budget</div>
        </div>
        <span class="badge max" id="badge-simulateur">MAX</span>
      </div>
      <div class="tool-content">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="field">
            <label>Type d'impr√©vu</label>
            <select id="imprevu-type">
              <option>üîß R√©paration voiture</option>
              <option>üè• Frais m√©dicaux</option>
              <option>üè† Travaux maison</option>
              <option>üì± Remplacement appareil</option>
            </select>
          </div>
          <div class="field">
            <label>Montant (‚Ç¨)</label>
            <input type="number" id="imprevu-montant" placeholder="1500">
          </div>
        </div>
        <div class="field" style="margin-top:16px">
          <label>√âtaler sur (mois)</label>
          <input type="number" id="imprevu-mois" value="3" min="1" max="24">
        </div>
        <button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="simuler()">üö® Simuler</button>
        <div id="simulateur-result" style="margin-top:20px"></div>
      </div>
      <div class="locked-overlay">
        <div class="locked-icon">üîí</div>
        <div class="locked-title">Plan Complet requis</div>
        <a href="tarifs.html" class="btn btn-primary">D√©bloquer</a>
      </div>
    </div>

    <!-- Pr√©l√®vements -->
    <div class="tool-card" id="tool-prelevements">
      <div class="tool-header">
        <div class="tool-icon">üìÖ</div>
        <div class="tool-info">
          <div class="tool-title">Pr√©l√®vements √† venir</div>
          <div class="tool-desc">Rappels de vos d√©penses r√©currentes</div>
        </div>
        <span class="badge pro" id="badge-prelevements">PRO</span>
      </div>
      <div class="tool-content">
        <div id="prelevements-list"></div>
        <button class="btn btn-secondary" style="margin-top:16px" onclick="openModal('modal-prelevement')">+ Ajouter un pr√©l√®vement</button>
      </div>
      <div class="locked-overlay">
        <div class="locked-icon">üîí</div>
        <div class="locked-title">Plan Essentiel requis</div>
        <a href="tarifs.html" class="btn btn-primary">D√©bloquer</a>
      </div>
    </div>

    <!-- Gestion abo -->
    <div class="tool-card">
      <div class="tool-header">
        <div class="tool-icon">‚≠ê</div>
        <div class="tool-info">
          <div class="tool-title">G√©rer mon abonnement</div>
          <div class="tool-desc">Modifier ou annuler votre plan</div>
        </div>
      </div>
      <div class="tool-content">
        <a href="tarifs.html" class="btn btn-primary">Voir les offres</a>
        <button class="btn btn-ghost" style="margin-left:12px" onclick="alert('Stripe Customer Portal √† configurer')">Portail Stripe</button>
      </div>
    </div>
  </div>
</main>

<!-- MODALS -->
<div class="modal" id="modal-movement">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Ajouter un mouvement</h3>
      <button class="modal-close" onclick="closeModal('modal-movement')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="type-selector" id="type-selector">
        <div class="type-option" onclick="selectType(this, 'revenu')"><div class="type-option-icon">üíµ</div><div class="type-option-label">Revenu</div></div>
        <div class="type-option" onclick="selectType(this, 'epargne')"><div class="type-option-icon">üíé</div><div class="type-option-label">√âpargne</div></div>
        <div class="type-option" onclick="selectType(this, 'essentiel')"><div class="type-option-icon">üè†</div><div class="type-option-label">Essentielle</div></div>
        <div class="type-option" onclick="selectType(this, 'non-essentiel')"><div class="type-option-icon">üõçÔ∏è</div><div class="type-option-label">Non ess.</div></div>
        <div class="type-option" onclick="selectType(this, 'imprevu')"><div class="type-option-icon">üö®</div><div class="type-option-label">Impr√©vu</div></div>
      </div>
      <div class="field"><label>Description</label><input type="text" id="movement-desc" placeholder="Ex: Salaire, Loyer..."></div>
      <div class="field" style="margin-top:16px"><label>Montant (‚Ç¨)</label><input type="number" id="movement-amount" placeholder="0" step="0.01"></div>
      <div class="field" style="margin-top:16px"><label>Date</label><input type="date" id="movement-date"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-movement')">Annuler</button>
      <button class="btn btn-primary" onclick="saveMovement()">Enregistrer</button>
    </div>
  </div>
</div>

<div class="modal" id="modal-epargne">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Objectif √©pargne</h3>
      <button class="modal-close" onclick="closeModal('modal-epargne')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="field"><label>Nom de l'objectif</label><input type="text" id="epargne-nom" placeholder="Ex: Voiture, Vacances..."></div>
      <div class="field" style="margin-top:16px"><label>Montant objectif (‚Ç¨)</label><input type="number" id="epargne-objectif-input" placeholder="10000"></div>
      <div class="field" style="margin-top:16px"><label>D√©j√† √©pargn√© (‚Ç¨)</label><input type="number" id="epargne-deja" placeholder="0"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-epargne')">Annuler</button>
      <button class="btn btn-primary" onclick="saveEpargne()">Enregistrer</button>
    </div>
  </div>
</div>

<div class="modal" id="modal-prelevement">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Ajouter un pr√©l√®vement</h3>
      <button class="modal-close" onclick="closeModal('modal-prelevement')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="field"><label>Nom</label><input type="text" id="prelevement-nom" placeholder="Ex: Netflix, EDF..."></div>
      <div class="field" style="margin-top:16px"><label>Montant (‚Ç¨)</label><input type="number" id="prelevement-montant" placeholder="15.99" step="0.01"></div>
      <div class="field" style="margin-top:16px"><label>Jour du mois</label><input type="number" id="prelevement-jour" placeholder="15" min="1" max="31"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-prelevement')">Annuler</button>
      <button class="btn btn-primary" onclick="savePrelevement()">Ajouter</button>
    </div>
  </div>
</div>

<!-- CHAT -->
<button class="chat-btn" id="chat-btn" onclick="toggleChat()">üí¨</button>
<div class="chat-window" id="chat-window">
  <div class="chat-header">
    <div class="chat-header-info">
      <span>ü§ñ</span>
      <strong>Assistant Budget</strong>
    </div>
    <button class="chat-close" onclick="toggleChat()">√ó</button>
  </div>
  <div id="chat-body"></div>
</div>

<script src="assets/nav-auth.js"></script>
<script>
// === GLOBAL VARIABLES ===
var selectedType = null;
var currentFilter = 'all';

// === HELPERS ===
function formatMoney(n) {
  return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0);
}

function formatDate(d) {
  return new Date(d).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
}

function getData(key, def) {
  try { var v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } 
  catch(e) { return def; }
}

function setData(key, val) {
  localStorage.setItem(key, JSON.stringify(val));
}

function getPlan() {
  return getData('plan', 'free');
}

function hasFeature(f) {
  var plan = getPlan();
  if (plan === 'complete') return true;
  if (plan === 'essential' && (f === 'comparateur' || f === 'prelevements')) return true;
  return false;
}

function getCurrentMonth() {
  var d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
}

function getMovements() {
  return getData('movements', []);
}

function getMovementsThisMonth() {
  var month = getCurrentMonth();
  return getMovements().filter(function(m) { return m.date && m.date.startsWith(month); });
}

// === NAVIGATION ===
function showTab(name) {
  console.log('showTab:', name);
  document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
  
  event.target.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

// === MODALS ===
function openModal(id) {
  console.log('openModal:', id);
  document.getElementById(id).classList.add('open');
  
  if (id === 'modal-movement') {
    document.getElementById('movement-date').value = new Date().toISOString().split('T')[0];
  }
  if (id === 'modal-epargne') {
    var obj = getData('epargneObjectif', {});
    document.getElementById('epargne-nom').value = obj.nom || '';
    document.getElementById('epargne-objectif-input').value = obj.montant || '';
    document.getElementById('epargne-deja').value = obj.deja || '';
  }
}

function closeModal(id) {
  console.log('closeModal:', id);
  document.getElementById(id).classList.remove('open');
}

// === TYPE SELECTOR ===
function selectType(el, type) {
  console.log('selectType:', type);
  document.querySelectorAll('.type-option').forEach(function(o) { o.classList.remove('selected'); });
  el.classList.add('selected');
  selectedType = type;
}

// === FILTERS ===
function filterMovements(filter, btn) {
  console.log('filterMovements:', filter);
  document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  currentFilter = filter;
  renderMovements();
}

// === IMPORT TEST ===
function importTest() {
  console.log('importTest called');
  var lastTest = getData('lastTest', null);
  if (!lastTest) {
    alert('Aucun test √† importer');
    return;
  }
  
  var movements = getMovements();
  var today = new Date().toISOString().split('T')[0];
  
  if (lastTest.revenus > 0) {
    movements.push({ id: 'imp_rev_' + Date.now(), type: 'revenu', desc: 'Revenus (import test)', amount: lastTest.revenus, date: today });
  }
  if (lastTest.depensesEssentielles > 0) {
    movements.push({ id: 'imp_ess_' + Date.now(), type: 'essentiel', desc: 'D√©penses essentielles (import)', amount: lastTest.depensesEssentielles, date: today });
  }
  if (lastTest.depensesNonEssentielles > 0) {
    movements.push({ id: 'imp_non_' + Date.now(), type: 'non-essentiel', desc: 'D√©penses non essentielles (import)', amount: lastTest.depensesNonEssentielles, date: today });
  }
  
  setData('movements', movements);
  setData('testImported', true);
  document.getElementById('import-banner').style.display = 'none';
  
  alert('Test import√© avec succ√®s !');
  renderAll();
}

// === SAVE FUNCTIONS ===
function saveMovement() {
  console.log('saveMovement called, type:', selectedType);
  
  if (!selectedType) {
    alert('S√©lectionnez un type de mouvement');
    return;
  }
  
  var desc = document.getElementById('movement-desc').value.trim();
  var amount = parseFloat(document.getElementById('movement-amount').value) || 0;
  var date = document.getElementById('movement-date').value;
  
  if (amount <= 0) {
    alert('Entrez un montant valide');
    return;
  }
  if (!date) {
    alert('S√©lectionnez une date');
    return;
  }
  
  var movements = getMovements();
  movements.push({
    id: 'mv_' + Date.now(),
    type: selectedType,
    desc: desc || selectedType,
    amount: amount,
    date: date
  });
  setData('movements', movements);
  
  // Reset
  selectedType = null;
  document.querySelectorAll('.type-option').forEach(function(o) { o.classList.remove('selected'); });
  document.getElementById('movement-desc').value = '';
  document.getElementById('movement-amount').value = '';
  
  closeModal('modal-movement');
  renderAll();
}

function saveEpargne() {
  console.log('saveEpargne called');
  var nom = document.getElementById('epargne-nom').value.trim();
  var montant = parseFloat(document.getElementById('epargne-objectif-input').value) || 0;
  var deja = parseFloat(document.getElementById('epargne-deja').value) || 0;
  
  setData('epargneObjectif', { nom: nom, montant: montant, deja: deja });
  closeModal('modal-epargne');
  renderEpargne();
}

function savePrelevement() {
  console.log('savePrelevement called');
  var nom = document.getElementById('prelevement-nom').value.trim();
  var montant = parseFloat(document.getElementById('prelevement-montant').value) || 0;
  var jour = parseInt(document.getElementById('prelevement-jour').value) || 1;
  
  if (!nom || montant <= 0) {
    alert('Remplissez tous les champs');
    return;
  }
  
  var list = getData('prelevements', []);
  list.push({ nom: nom, montant: montant, jour: jour });
  setData('prelevements', list);
  
  document.getElementById('prelevement-nom').value = '';
  document.getElementById('prelevement-montant').value = '';
  document.getElementById('prelevement-jour').value = '';
  
  closeModal('modal-prelevement');
  renderPrelevements();
}

function deleteMovement(id) {
  console.log('deleteMovement:', id);
  if (!confirm('Supprimer ce mouvement ?')) return;
  
  var movements = getMovements().filter(function(m) { return m.id !== id; });
  setData('movements', movements);
  renderAll();
}

function deletePrelevement(idx) {
  console.log('deletePrelevement:', idx);
  if (!confirm('Supprimer ce pr√©l√®vement ?')) return;
  
  var list = getData('prelevements', []);
  list.splice(idx, 1);
  setData('prelevements', list);
  renderPrelevements();
}

// === TOOLS ===
function comparer() {
  console.log('comparer called');
  var nomA = document.getElementById('compare-a-nom').value || 'Choix A';
  var coutA = parseFloat(document.getElementById('compare-a-cout').value) || 0;
  var dureeA = parseInt(document.getElementById('compare-a-duree').value) || 1;
  var nomB = document.getElementById('compare-b-nom').value || 'Choix B';
  var coutB = parseFloat(document.getElementById('compare-b-cout').value) || 0;
  var dureeB = parseInt(document.getElementById('compare-b-duree').value) || 1;
  
  var totalA = coutA * dureeA;
  var totalB = coutB * dureeB;
  var diff = Math.abs(totalA - totalB);
  
  var html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">';
  html += '<div style="text-align:center"><div style="font-size:12px;color:#6b7280">' + nomA + '</div><div style="font-size:24px;font-weight:700;color:#0d9f6f">' + formatMoney(totalA) + '</div></div>';
  html += '<div style="text-align:center"><div style="font-size:12px;color:#6b7280">' + nomB + '</div><div style="font-size:24px;font-weight:700;color:#3b82f6">' + formatMoney(totalB) + '</div></div>';
  html += '</div><div style="text-align:center;padding:16px;background:#fff;border-radius:8px">';
  html += '<div style="font-size:12px;color:#6b7280">Diff√©rence</div><div style="font-size:28px;font-weight:700">' + formatMoney(diff) + '</div>';
  if (totalA !== totalB) {
    var winner = totalA < totalB ? nomA : nomB;
    html += '<div style="color:#0d9f6f;font-weight:600;margin-top:8px">‚úÖ ' + winner + ' est plus √©conomique</div>';
  }
  html += '</div>';
  
  var result = document.getElementById('compare-result');
  result.innerHTML = html;
  result.style.display = 'block';
}

function simuler() {
  console.log('simuler called');
  var stats = calculateStats();
  
  if (stats.revenus <= 0) {
    alert('Ajoutez d\'abord vos revenus dans le journal');
    return;
  }
  
  var montant = parseFloat(document.getElementById('imprevu-montant').value) || 0;
  var mois = parseInt(document.getElementById('imprevu-mois').value) || 1;
  
  if (montant <= 0) {
    alert('Entrez un montant');
    return;
  }
  
  var coutMensuel = montant / mois;
  var nouveauReste = stats.resteAVivre - coutMensuel;
  
  var status, icon, title, message, bgColor;
  if (nouveauReste >= stats.resteAVivre * 0.5) {
    status = 'success'; icon = '‚úÖ'; title = 'Absorbable'; message = 'Votre budget peut g√©rer.';
    bgColor = 'rgba(13,159,111,0.1)';
  } else if (nouveauReste >= 0) {
    status = 'warning'; icon = '‚ö†Ô∏è'; title = 'Tendu'; message = 'Budget serr√© mais faisable.';
    bgColor = 'rgba(245,158,11,0.1)';
  } else {
    status = 'danger'; icon = '‚ùå'; title = 'Critique'; message = 'D√©passe votre capacit√©.';
    bgColor = 'rgba(220,38,38,0.1)';
  }
  
  var html = '<div style="padding:20px;background:' + bgColor + ';border-radius:12px">';
  html += '<div style="display:flex;align-items:center;gap:16px;margin-bottom:16px"><span style="font-size:40px">' + icon + '</span><div><div style="font-size:18px;font-weight:700">' + title + '</div><div style="color:#6b7280">' + message + '</div></div></div>';
  html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">';
  html += '<div style="text-align:center;padding:12px;background:#fff;border-radius:8px"><div style="font-size:11px;color:#6b7280">Reste actuel</div><div style="font-size:18px;font-weight:700">' + formatMoney(stats.resteAVivre) + '</div></div>';
  html += '<div style="text-align:center;padding:12px;background:#fff;border-radius:8px"><div style="font-size:11px;color:#6b7280">Co√ªt/mois</div><div style="font-size:18px;font-weight:700;color:#dc2626">-' + formatMoney(coutMensuel) + '</div></div>';
  html += '<div style="text-align:center;padding:12px;background:#fff;border-radius:8px"><div style="font-size:11px;color:#6b7280">Nouveau reste</div><div style="font-size:18px;font-weight:700;color:' + (nouveauReste >= 0 ? '#0d9f6f' : '#dc2626') + '">' + formatMoney(nouveauReste) + '</div></div>';
  html += '</div></div>';
  
  document.getElementById('simulateur-result').innerHTML = html;
}

// === CHAT ===
function toggleChat() {
  console.log('toggleChat called');
  var win = document.getElementById('chat-window');
  win.classList.toggle('open');
  
  if (win.classList.contains('open')) {
    renderChat();
  }
}

function renderChat() {
  console.log('renderChat called');
  var body = document.getElementById('chat-body');
  
  if (!hasFeature('chat')) {
    body.innerHTML = '<div class="chat-locked"><div style="font-size:48px;margin-bottom:16px">üîí</div><div style="font-size:18px;font-weight:600;margin-bottom:8px">Fonctionnalit√© Premium</div><p style="color:#6b7280;margin-bottom:20px">Disponible avec le plan Complet.</p><a href="tarifs.html" class="btn btn-primary">D√©bloquer</a></div>';
    return;
  }
  
  body.innerHTML = '<div class="chat-messages" id="chat-messages"><div class="chat-message bot">Bonjour ! Comment puis-je vous aider ?</div></div><div class="chat-input-area"><input type="text" class="chat-input" id="chat-input" placeholder="Posez votre question..." onkeypress="if(event.key===\'Enter\')sendChat()"><button class="chat-send" onclick="sendChat()">‚û§</button></div>';
  
  // Load history
  var history = getData('chatHistory', []);
  if (history.length > 0) {
    var msgEl = document.getElementById('chat-messages');
    msgEl.innerHTML = '';
    history.forEach(function(m) {
      msgEl.innerHTML += '<div class="chat-message ' + m.type + '">' + m.text + '</div>';
    });
    msgEl.scrollTop = msgEl.scrollHeight;
  }
}

function sendChat() {
  console.log('sendChat called');
  var input = document.getElementById('chat-input');
  var text = input.value.trim();
  if (!text) return;
  
  var history = getData('chatHistory', []);
  history.push({ type: 'user', text: text });
  
  // Bot response
  var response = getBotResponse(text);
  history.push({ type: 'bot', text: response });
  
  if (history.length > 50) history = history.slice(-50);
  setData('chatHistory', history);
  
  var msgEl = document.getElementById('chat-messages');
  msgEl.innerHTML += '<div class="chat-message user">' + text + '</div>';
  msgEl.innerHTML += '<div class="chat-message bot">' + response + '</div>';
  msgEl.scrollTop = msgEl.scrollHeight;
  
  input.value = '';
}

function getBotResponse(text) {
  var t = text.toLowerCase();
  var stats = calculateStats();
  
  if (t.match(/bonjour|salut|hello|coucou/)) return 'Bonjour ! Comment puis-je vous aider ?';
  if (t.match(/score|sant√©|sante/)) return 'Votre score est de ' + calculateScore(stats) + '/100.';
  if (t.match(/reste|vivre|disponible/)) return 'Reste √† vivre : ' + formatMoney(stats.resteAVivre);
  if (t.match(/√©pargne|epargne/)) return '√âpargne ce mois : ' + formatMoney(stats.epargne);
  if (t.match(/conseil|aide/)) {
    if (stats.resteAVivre < 0) return 'Budget en d√©ficit. R√©duisez les d√©penses non essentielles.';
    if (stats.epargne === 0) return 'Essayez d\'√©pargner m√™me un petit montant.';
    return 'Vous g√©rez bien ! Continuez.';
  }
  return 'Je peux vous aider avec : score, reste √† vivre, √©pargne, conseils.';
}

// === CALCULATIONS ===
function calculateStats() {
  var movements = getMovementsThisMonth();
  var stats = { revenus: 0, essentielles: 0, nonEssentielles: 0, epargne: 0, imprevu: 0 };
  
  movements.forEach(function(m) {
    var amt = Math.abs(m.amount || 0);
    if (m.type === 'revenu') stats.revenus += amt;
    else if (m.type === 'essentiel') stats.essentielles += amt;
    else if (m.type === 'non-essentiel') stats.nonEssentielles += amt;
    else if (m.type === 'epargne') stats.epargne += amt;
    else if (m.type === 'imprevu') stats.imprevu += amt;
  });
  
  stats.totalDepenses = stats.essentielles + stats.nonEssentielles + stats.imprevu;
  stats.resteAVivre = stats.revenus - stats.totalDepenses - stats.epargne;
  return stats;
}

function calculateScore(stats) {
  if (stats.revenus <= 0) return 0;
  var score = 0;
  var ratio = stats.resteAVivre / stats.revenus;
  if (ratio >= 0.20) score += 50;
  else if (ratio >= 0.10) score += 35;
  else if (ratio >= 0) score += 20;
  
  var epRatio = stats.epargne / stats.revenus;
  if (epRatio >= 0.20) score += 30;
  else if (epRatio >= 0.10) score += 20;
  else if (epRatio > 0) score += 10;
  
  if (stats.imprevu === 0) score += 10;
  if (stats.revenus > 0 && stats.nonEssentielles / stats.revenus < 0.30) score += 10;
  
  return Math.min(100, Math.max(0, score));
}

// === RENDER FUNCTIONS ===
function renderPlan() {
  var plan = getPlan();
  var icons = { free: '‚≠ê', essential: 'üíé', complete: 'üëë' };
  var names = { free: 'Gratuit', essential: 'Essentiel', complete: 'Complet' };
  var descs = { free: 'Fonctionnalit√©s de base', essential: 'Outils de gestion', complete: 'Toutes les fonctionnalit√©s' };
  
  document.getElementById('plan-icon').textContent = icons[plan] || '‚≠ê';
  document.getElementById('plan-name').textContent = 'Plan ' + (names[plan] || 'Gratuit');
  document.getElementById('plan-desc').textContent = descs[plan] || '';
}

function renderStats() {
  var stats = calculateStats();
  
  document.getElementById('stat-revenus').textContent = formatMoney(stats.revenus);
  document.getElementById('stat-essentielles').textContent = formatMoney(stats.essentielles);
  document.getElementById('stat-non-essentielles').textContent = formatMoney(stats.nonEssentielles);
  
  var resteEl = document.getElementById('stat-reste');
  resteEl.textContent = formatMoney(stats.resteAVivre);
  resteEl.className = 'stat-value ' + (stats.resteAVivre >= 0 ? 'positive' : 'negative');
  
  // Score
  var score = calculateScore(stats);
  document.getElementById('score-number').textContent = score;
  
  var circ = 2 * Math.PI * 60;
  document.getElementById('score-circle').style.strokeDashoffset = circ - (score / 100) * circ;
  
  var badge = document.getElementById('score-badge');
  if (score >= 70) { badge.textContent = 'Excellente sant√©'; badge.className = 'badge success'; }
  else if (score >= 50) { badge.textContent = 'Bonne gestion'; badge.className = 'badge success'; }
  else if (score >= 30) { badge.textContent = '√Ä am√©liorer'; badge.className = 'badge warning'; }
  else { badge.textContent = 'Attention requise'; badge.className = 'badge danger'; }
  
  // R√©sum√©
  document.getElementById('resume-entrees').textContent = '+' + formatMoney(stats.revenus);
  document.getElementById('resume-sorties').textContent = '-' + formatMoney(stats.totalDepenses + stats.epargne);
  var solde = stats.revenus - stats.totalDepenses - stats.epargne;
  var soldeEl = document.getElementById('resume-solde');
  soldeEl.textContent = formatMoney(solde);
  soldeEl.style.color = solde >= 0 ? '#0d9f6f' : '#dc2626';
}

function renderEpargne() {
  var stats = calculateStats();
  var obj = getData('epargneObjectif', { nom: '', montant: 0, deja: 0 });
  var total = (obj.deja || 0) + stats.epargne;
  
  document.getElementById('epargne-objectif-text').textContent = obj.nom ? obj.nom + ' - ' + formatMoney(obj.montant) : 'D√©finir un objectif';
  
  var pct = obj.montant > 0 ? Math.min(100, Math.round((total / obj.montant) * 100)) : 0;
  var restant = Math.max(0, obj.montant - total);
  var conseille = restant > 0 ? Math.ceil(restant / 12) : 0;
  
  document.getElementById('epargne-total').textContent = formatMoney(total);
  document.getElementById('epargne-mois').textContent = formatMoney(stats.epargne);
  document.getElementById('epargne-restant').textContent = formatMoney(restant);
  document.getElementById('epargne-conseille').textContent = formatMoney(conseille);
  document.getElementById('epargne-progress').style.width = pct + '%';
}

function renderMissions() {
  var movements = getMovementsThisMonth();
  var stats = calculateStats();
  
  var missions = [
    { id: 'revenus', text: 'Ajouter vos revenus', done: stats.revenus > 0, points: 10 },
    { id: 'mouvements', text: 'Enregistrer 3 mouvements', done: movements.length >= 3, points: 15 },
    { id: 'epargne', text: '√âpargner ce mois', done: stats.epargne > 0, points: 25 }
  ];
  
  var html = '';
  var count = 0;
  missions.forEach(function(m) {
    if (m.done) count++;
    html += '<div class="mission' + (m.done ? ' completed' : '') + '">';
    html += '<div class="mission-check">' + (m.done ? '‚úì' : '') + '</div>';
    html += '<div class="mission-text">' + m.text + '</div>';
    html += '<div class="mission-points">+' + m.points + ' pts</div>';
    html += '</div>';
  });
  
  document.getElementById('missions-list').innerHTML = html;
  document.getElementById('missions-progress').textContent = count + '/' + missions.length;
}

function renderMovements() {
  var movements = getMovementsThisMonth();
  
  if (currentFilter !== 'all') {
    movements = movements.filter(function(m) { return m.type === currentFilter; });
  }
  
  movements.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
  
  var container = document.getElementById('movement-list');
  
  if (movements.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>Aucun mouvement</p><button class="btn btn-primary" style="margin-top:16px" onclick="openModal(\'modal-movement\')">Ajouter un mouvement</button></div>';
    return;
  }
  
  var icons = { revenu: 'üíµ', epargne: 'üíé', essentiel: 'üè†', 'non-essentiel': 'üõçÔ∏è', imprevu: 'üö®' };
  var labels = { revenu: 'Revenu', epargne: '√âpargne', essentiel: 'Essentielle', 'non-essentiel': 'Non essentielle', imprevu: 'Impr√©vu' };
  
  var html = '';
  movements.forEach(function(m) {
    var isPos = m.type === 'revenu';
    html += '<div class="movement">';
    html += '<div class="movement-icon ' + m.type + '">' + (icons[m.type] || 'üì¶') + '</div>';
    html += '<div class="movement-info">';
    html += '<div class="movement-title">' + (m.desc || labels[m.type] || 'Mouvement') + '</div>';
    html += '<div class="movement-meta">' + (labels[m.type] || '') + ' ‚Ä¢ ' + formatDate(m.date) + '</div>';
    html += '</div>';
    html += '<div class="movement-amount ' + (isPos ? 'positive' : 'negative') + '">' + (isPos ? '+' : '-') + formatMoney(Math.abs(m.amount)) + '</div>';
    html += '<button class="movement-delete" onclick="deleteMovement(\'' + m.id + '\')">üóëÔ∏è</button>';
    html += '</div>';
  });
  
  container.innerHTML = html;
}

function renderPrelevements() {
  var list = getData('prelevements', []);
  var container = document.getElementById('prelevements-list');
  
  if (list.length === 0) {
    container.innerHTML = '<div class="empty-state" style="padding:24px"><p>Aucun pr√©l√®vement</p></div>';
    return;
  }
  
  list.sort(function(a, b) { return a.jour - b.jour; });
  var mois = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];
  var now = new Date();
  
  var html = '';
  list.forEach(function(p, i) {
    html += '<div class="prelevement">';
    html += '<div class="prelevement-date"><div class="prelevement-day">' + p.jour + '</div><div class="prelevement-month">' + mois[now.getMonth()] + '</div></div>';
    html += '<div class="prelevement-info"><div class="prelevement-name">' + p.nom + '</div></div>';
    html += '<div class="prelevement-amount">-' + formatMoney(p.montant) + '</div>';
    html += '<button class="movement-delete" onclick="deletePrelevement(' + i + ')">üóëÔ∏è</button>';
    html += '</div>';
  });
  
  container.innerHTML = html;
}

function renderToolAccess() {
  var plan = getPlan();
  
  // Comparateur: essential+
  var compLocked = !hasFeature('comparateur');
  document.getElementById('tool-comparateur').classList.toggle('locked-tool', compLocked);
  document.getElementById('badge-comparateur').style.display = compLocked ? '' : 'none';
  
  // Simulateur: complete only
  var simLocked = !hasFeature('simulateur');
  document.getElementById('tool-simulateur').classList.toggle('locked-tool', simLocked);
  document.getElementById('badge-simulateur').style.display = simLocked ? '' : 'none';
  
  // Pr√©l√®vements: essential+
  var prelLocked = !hasFeature('prelevements');
  document.getElementById('tool-prelevements').classList.toggle('locked-tool', prelLocked);
  document.getElementById('badge-prelevements').style.display = prelLocked ? '' : 'none';
}

function checkTestImport() {
  var lastTest = getData('lastTest', null);
  var imported = getData('testImported', false);
  
  if (lastTest && !imported) {
    document.getElementById('import-banner').style.display = 'flex';
  } else {
    document.getElementById('import-banner').style.display = 'none';
  }
}

function renderAll() {
  console.log('renderAll called');
  checkTestImport();
  renderPlan();
  renderStats();
  renderEpargne();
  renderMissions();
  renderMovements();
  renderPrelevements();
  renderToolAccess();
}

// === INIT ===
function init() {
  console.log('Dashboard init');
  
  // Check auth
  try {
    var session = JSON.parse(localStorage.getItem('auth_session_v1'));
    if (!session || !session.email) {
      console.log('Not logged in, redirecting...');
      window.location.replace('login.html');
      return;
    }
    console.log('Logged in as:', session.email);
  } catch(e) {
    console.log('Auth error:', e);
    window.location.replace('login.html');
    return;
  }
  
  renderAll();
  console.log('Dashboard ready');
}

// Start
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>

</body>
</html>