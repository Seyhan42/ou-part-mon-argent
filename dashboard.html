<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard ‚Äì O√π part mon argent ?</title>
  <link rel="stylesheet" href="css/style.css?v=4">
  <style>
    /* === DASHBOARD STYLES === */
    .dashboard { max-width: 1000px; margin: 0 auto; padding: var(--space-lg) var(--space-md); }
    
    /* Tabs */
    .tabs { display: flex; gap: var(--space-xs); background: var(--bg-card); padding: var(--space-xs); border-radius: var(--radius-lg); border: 1px solid var(--border-light); margin-bottom: var(--space-lg); }
    .tab { flex: 1; padding: var(--space-md); border: none; background: transparent; border-radius: var(--radius-md); font-weight: 600; font-size: var(--text-sm); cursor: pointer; transition: all 0.2s; color: var(--text-muted); }
    .tab:hover { background: var(--bg-subtle); color: var(--text-primary); }
    .tab.active { background: var(--accent); color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Plan Banner */
    .plan-banner { display: flex; justify-content: space-between; align-items: center; padding: var(--space-md) var(--space-lg); background: linear-gradient(135deg, var(--accent-subtle), rgba(59,130,246,0.1)); border-radius: var(--radius-lg); margin-bottom: var(--space-lg); border: 1px solid var(--accent-border); }
    .plan-info { display: flex; align-items: center; gap: var(--space-md); }
    .plan-icon { font-size: 24px; }
    .plan-name { font-weight: 700; font-size: var(--text-lg); }
    .plan-desc { font-size: var(--text-sm); color: var(--text-muted); }
    
    /* Score Circle */
    .score-section { text-align: center; padding: var(--space-lg); }
    .score-circle { position: relative; width: 140px; height: 140px; margin: 0 auto var(--space-md); }
    .score-circle svg { transform: rotate(-90deg); }
    .score-circle-bg { fill: none; stroke: var(--border-light); stroke-width: 12; }
    .score-circle-fill { fill: none; stroke: var(--accent); stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 1s ease; }
    .score-value { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .score-number { font-size: 36px; font-weight: 800; }
    .score-label { font-size: var(--text-xs); color: var(--text-muted); }
    
    /* Missions */
    .missions { margin-top: var(--space-lg); }
    .mission { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md); background: var(--bg-subtle); border-radius: var(--radius-md); margin-bottom: var(--space-sm); }
    .mission.completed { background: var(--accent-subtle); }
    .mission-check { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border-medium); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
    .mission.completed .mission-check { background: var(--accent); border-color: var(--accent); color: #fff; }
    .mission-text { flex: 1; font-size: var(--text-sm); }
    .mission-points { font-size: var(--text-xs); font-weight: 600; color: var(--accent); }
    
    /* √âpargne Progress */
    .epargne-card { background: linear-gradient(135deg, #0d9f6f, #0b8a5e); color: #fff; border-radius: var(--radius-lg); padding: var(--space-xl); margin-top: var(--space-lg); }
    .epargne-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md); }
    .epargne-title { font-size: var(--text-lg); font-weight: 700; }
    .epargne-objectif { font-size: var(--text-sm); opacity: 0.9; }
    .epargne-progress { height: 12px; background: rgba(255,255,255,0.3); border-radius: var(--radius-full); overflow: hidden; margin-bottom: var(--space-md); }
    .epargne-progress-fill { height: 100%; background: #fff; border-radius: var(--radius-full); transition: width 0.5s; }
    .epargne-stats { display: flex; justify-content: space-between; font-size: var(--text-sm); }
    .epargne-stat { text-align: center; }
    .epargne-stat-value { font-size: var(--text-xl); font-weight: 700; }
    .epargne-stat-label { opacity: 0.8; font-size: var(--text-xs); }
    
    /* Journal */
    .journal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); }
    .journal-filters { display: flex; gap: var(--space-sm); }
    .filter-btn { padding: var(--space-xs) var(--space-md); border: 1px solid var(--border-light); background: var(--bg-card); border-radius: var(--radius-full); font-size: var(--text-xs); cursor: pointer; transition: all 0.2s; }
    .filter-btn:hover, .filter-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    
    .movement-list { display: flex; flex-direction: column; gap: var(--space-sm); }
    .movement { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md); background: var(--bg-card); border: 1px solid var(--border-light); border-radius: var(--radius-md); }
    .movement-icon { width: 40px; height: 40px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
    .movement-icon.epargne { background: var(--accent-subtle); }
    .movement-icon.essentiel { background: rgba(59,130,246,0.1); }
    .movement-icon.non-essentiel { background: rgba(245,158,11,0.1); }
    .movement-icon.imprevu { background: rgba(220,38,38,0.1); }
    .movement-icon.revenu { background: rgba(34,197,94,0.1); }
    .movement-info { flex: 1; }
    .movement-title { font-weight: 600; font-size: var(--text-sm); }
    .movement-meta { font-size: var(--text-xs); color: var(--text-muted); }
    .movement-amount { font-weight: 700; font-size: var(--text-base); }
    .movement-amount.positive { color: var(--accent); }
    .movement-amount.negative { color: var(--danger); }
    .movement-delete { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: var(--space-xs); border-radius: var(--radius-sm); }
    .movement-delete:hover { background: rgba(220,38,38,0.1); color: var(--danger); }
    
    .empty-state { text-align: center; padding: var(--space-2xl); color: var(--text-muted); }
    .empty-state-icon { font-size: 48px; margin-bottom: var(--space-md); }
    
    /* Outils */
    .tool-card { background: var(--bg-card); border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: var(--space-lg); margin-bottom: var(--space-lg); }
    .tool-header { display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-lg); }
    .tool-icon { width: 48px; height: 48px; background: var(--bg-subtle); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 24px; }
    .tool-title { font-size: var(--text-lg); font-weight: 700; }
    .tool-desc { font-size: var(--text-sm); color: var(--text-muted); }
    
    .locked-tool { position: relative; }
    .locked-tool::after { content: ''; position: absolute; inset: 0; background: rgba(255,255,255,0.8); border-radius: var(--radius-lg); }
    .locked-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1; text-align: center; padding: var(--space-lg); }
    .locked-overlay .locked-icon { font-size: 48px; margin-bottom: var(--space-md); }
    .locked-overlay .locked-title { font-size: var(--text-lg); font-weight: 600; margin-bottom: var(--space-sm); }
    
    /* Compare */
    .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); }
    .compare-box { padding: var(--space-lg); border-radius: var(--radius-md); }
    .compare-box.a { background: var(--accent-subtle); border: 2px solid var(--accent); }
    .compare-box.b { background: rgba(59,130,246,0.1); border: 2px solid #3b82f6; }
    .compare-label { display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-md); }
    .compare-badge { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #fff; font-size: var(--text-sm); }
    .compare-badge.a { background: var(--accent); }
    .compare-badge.b { background: #3b82f6; }
    .compare-result { margin-top: var(--space-lg); padding: var(--space-lg); background: var(--bg-subtle); border-radius: var(--radius-md); text-align: center; }
    
    /* Pr√©l√®vements */
    .prelevement { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md); background: var(--bg-subtle); border-radius: var(--radius-md); margin-bottom: var(--space-sm); }
    .prelevement-date { width: 50px; text-align: center; }
    .prelevement-day { font-size: var(--text-xl); font-weight: 700; }
    .prelevement-month { font-size: var(--text-xs); color: var(--text-muted); }
    .prelevement-info { flex: 1; }
    .prelevement-name { font-weight: 600; }
    .prelevement-amount { font-weight: 700; color: var(--danger); }
    
    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: var(--space-md); }
    .modal.open { display: flex; }
    .modal-content { background: #fff; border-radius: var(--radius-xl); max-width: 450px; width: 100%; max-height: 90vh; overflow: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-lg); border-bottom: 1px solid var(--border-light); }
    .modal-title { font-size: var(--text-lg); font-weight: 700; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted); padding: 4px; }
    .modal-body { padding: var(--space-lg); }
    .modal-footer { padding: var(--space-lg); border-top: 1px solid var(--border-light); display: flex; gap: var(--space-md); justify-content: flex-end; }
    
    /* Type selector */
    .type-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-sm); margin-bottom: var(--space-lg); }
    .type-option { padding: var(--space-md); border: 2px solid var(--border-light); border-radius: var(--radius-md); cursor: pointer; text-align: center; transition: all 0.2s; }
    .type-option:hover { border-color: var(--accent); }
    .type-option.selected { border-color: var(--accent); background: var(--accent-subtle); }
    .type-option-icon { font-size: 24px; margin-bottom: var(--space-xs); }
    .type-option-label { font-size: var(--text-sm); font-weight: 600; }
    
    /* Chat Widget */
    .chat-btn { position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #0d9f6f, #0b8a5e); color: #fff; border: none; cursor: pointer; font-size: 28px; box-shadow: 0 4px 20px rgba(13,159,111,0.4); z-index: 999; transition: transform 0.2s; }
    .chat-btn:hover { transform: scale(1.05); }
    .chat-window { position: fixed; bottom: 100px; right: 24px; width: 380px; max-width: calc(100vw - 48px); height: 500px; max-height: calc(100vh - 150px); background: #fff; border-radius: var(--radius-xl); box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: none; flex-direction: column; overflow: hidden; z-index: 1000; }
    .chat-window.open { display: flex; }
    .chat-header { background: linear-gradient(135deg, #0d9f6f, #0b8a5e); color: #fff; padding: var(--space-md) var(--space-lg); display: flex; justify-content: space-between; align-items: center; }
    .chat-header-info { display: flex; align-items: center; gap: var(--space-sm); }
    .chat-header-info span { font-size: 20px; }
    .chat-header-info h4 { font-size: var(--text-sm); margin: 0; }
    .chat-close { background: rgba(255,255,255,0.2); border: none; color: #fff; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; }
    .chat-messages { flex: 1; overflow-y: auto; padding: var(--space-md); display: flex; flex-direction: column; gap: var(--space-sm); background: var(--bg-subtle); }
    .chat-message { max-width: 85%; padding: var(--space-sm) var(--space-md); border-radius: var(--radius-lg); font-size: var(--text-sm); line-height: 1.5; }
    .chat-message.bot { background: #fff; align-self: flex-start; border-bottom-left-radius: 4px; }
    .chat-message.user { background: var(--accent); color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; }
    .chat-input-area { padding: var(--space-md); background: #fff; border-top: 1px solid var(--border-light); display: flex; gap: var(--space-sm); }
    .chat-input { flex: 1; padding: var(--space-sm) var(--space-md); border: 1px solid var(--border-light); border-radius: var(--radius-full); font-size: var(--text-sm); }
    .chat-input:focus { outline: none; border-color: var(--accent); }
    .chat-send { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); color: #fff; border: none; cursor: pointer; font-size: 16px; }
    .chat-locked { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--space-xl); text-align: center; background: var(--bg-subtle); }
    
    /* Responsive */
    @media (max-width: 768px) {
      .tabs { flex-wrap: wrap; }
      .tab { padding: var(--space-sm); font-size: var(--text-xs); }
      .plan-banner { flex-direction: column; text-align: center; gap: var(--space-md); }
      .score-circle { width: 120px; height: 120px; }
      .score-number { font-size: 28px; }
      .compare-grid { grid-template-columns: 1fr; }
      .epargne-stats { flex-wrap: wrap; gap: var(--space-md); }
      .epargne-stat { flex: 1; min-width: 80px; }
      .journal-header { flex-direction: column; gap: var(--space-md); align-items: stretch; }
      .journal-filters { justify-content: center; flex-wrap: wrap; }
      .type-selector { grid-template-columns: 1fr 1fr; }
      .chat-window { bottom: 0; right: 0; left: 0; width: 100%; max-width: 100%; height: 80vh; border-radius: var(--radius-xl) var(--radius-xl) 0 0; }
    }
  </style>
</head>
<body>

<header class="header">
  <div class="brand">
    <div class="logo">‚Ç¨</div>
    <div>
      <div class="brand-title">O√π part mon argent ?</div>
      <div class="brand-subtitle">Dashboard</div>
    </div>
  </div>
  <nav class="nav">
    <a class="nav-link" href="index.html">Accueil</a>
    <a class="nav-link" href="test.html">Test gratuit</a>
    <a class="nav-link" href="tarifs.html">Tarifs</a>
    <a class="nav-link" href="login.html" data-auth="out">Connexion</a>
    <a class="nav-link active" href="dashboard.html" data-auth="in">Dashboard</a>
    <button class="btn-ghost" type="button" data-auth="in" data-logout>D√©connexion</button>
  </nav>
</header>

<main class="dashboard">
  <!-- Plan Banner -->
  <div class="plan-banner">
    <div class="plan-info">
      <div class="plan-icon" id="plan-icon">‚≠ê</div>
      <div>
        <div class="plan-name" id="plan-name">Plan Gratuit</div>
        <div class="plan-desc" id="plan-desc">Fonctionnalit√©s de base</div>
      </div>
    </div>
    <a href="tarifs.html" class="btn btn-ghost" id="plan-btn">Am√©liorer</a>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="apercu">üìä Aper√ßu</button>
    <button class="tab" data-tab="mouvements">üìã Mouvements</button>
    <button class="tab" data-tab="outils">üõ†Ô∏è Outils</button>
  </div>

  <!-- ==================== APER√áU ==================== -->
  <div class="tab-content active" id="tab-apercu">
    
    <!-- R√©sum√© Financier -->
    <div class="grid-4 mb-lg" style="margin-bottom:24px">
      <div class="stat-card">
        <div class="stat-label">üíµ Revenus</div>
        <div class="stat-value" id="stat-revenus">0 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">üè† Essentielles</div>
        <div class="stat-value" id="stat-essentielles">0 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">üõçÔ∏è Non essentielles</div>
        <div class="stat-value" id="stat-non-essentielles">0 ‚Ç¨</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">‚ú® Reste √† vivre</div>
        <div class="stat-value positive" id="stat-reste">0 ‚Ç¨</div>
      </div>
    </div>

    <div class="grid-2">
      <!-- Score -->
      <div class="card">
        <h3 style="text-align:center;margin-bottom:0">Score sant√© financi√®re</h3>
        <div class="score-section">
          <div class="score-circle">
            <svg width="140" height="140" viewBox="0 0 140 140">
              <circle class="score-circle-bg" cx="70" cy="70" r="60"/>
              <circle class="score-circle-fill" id="score-circle" cx="70" cy="70" r="60" 
                stroke-dasharray="377" stroke-dashoffset="377"/>
            </svg>
            <div class="score-value">
              <div class="score-number" id="score-number">0</div>
              <div class="score-label">/ 100</div>
            </div>
          </div>
          <span class="badge" id="score-badge">‚Äî</span>
        </div>
      </div>

      <!-- Missions -->
      <div class="card">
        <h3>üéØ Missions de la semaine</h3>
        <div class="missions" id="missions-list">
          <!-- G√©n√©r√© par JS -->
        </div>
        <div style="text-align:center;margin-top:16px">
          <span class="badge success" id="missions-progress">0/5 compl√©t√©es</span>
        </div>
      </div>
    </div>

    <!-- √âpargne -->
    <div class="epargne-card" id="epargne-card">
      <div class="epargne-header">
        <div>
          <div class="epargne-title">üíé Objectif √©pargne</div>
          <div class="epargne-objectif" id="epargne-objectif-text">D√©finir un objectif</div>
        </div>
        <button class="btn btn-ghost" style="background:rgba(255,255,255,0.2);color:#fff;border:none" id="btn-edit-epargne">‚öôÔ∏è</button>
      </div>
      <div class="epargne-progress">
        <div class="epargne-progress-fill" id="epargne-progress" style="width:0%"></div>
      </div>
      <div class="epargne-stats">
        <div class="epargne-stat">
          <div class="epargne-stat-value" id="epargne-total">0 ‚Ç¨</div>
          <div class="epargne-stat-label">Total √©pargn√©</div>
        </div>
        <div class="epargne-stat">
          <div class="epargne-stat-value" id="epargne-mois">0 ‚Ç¨</div>
          <div class="epargne-stat-label">Ce mois</div>
        </div>
        <div class="epargne-stat">
          <div class="epargne-stat-value" id="epargne-restant">0 ‚Ç¨</div>
          <div class="epargne-stat-label">Restant</div>
        </div>
        <div class="epargne-stat">
          <div class="epargne-stat-value" id="epargne-conseille">0 ‚Ç¨</div>
          <div class="epargne-stat-label">Conseill√©/mois</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== MOUVEMENTS ==================== -->
  <div class="tab-content" id="tab-mouvements">
    <div class="journal-header">
      <div>
        <h2>üìã Journal des mouvements</h2>
        <p class="muted small">Toutes vos entr√©es/sorties d'argent</p>
      </div>
      <button class="btn btn-primary" id="btn-add-movement">+ Ajouter</button>
    </div>

    <div class="journal-filters">
      <button class="filter-btn active" data-filter="all">Tous</button>
      <button class="filter-btn" data-filter="revenu">üíµ Revenus</button>
      <button class="filter-btn" data-filter="epargne">üíé √âpargne</button>
      <button class="filter-btn" data-filter="essentiel">üè† Essentielles</button>
      <button class="filter-btn" data-filter="non-essentiel">üõçÔ∏è Non ess.</button>
      <button class="filter-btn" data-filter="imprevu">üö® Impr√©vus</button>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="movement-list" id="movement-list">
        <div class="empty-state">
          <div class="empty-state-icon">üìù</div>
          <p>Aucun mouvement ce mois</p>
          <button class="btn btn-primary mt-md" id="btn-add-first">Ajouter mon premier mouvement</button>
        </div>
      </div>
    </div>

    <!-- R√©sum√© du mois -->
    <div class="card mt-lg">
      <h3>üìä R√©sum√© du mois</h3>
      <div class="grid-3" style="margin-top:16px">
        <div style="text-align:center;padding:16px;background:var(--accent-subtle);border-radius:8px">
          <div style="font-size:24px;font-weight:700;color:var(--accent)" id="resume-entrees">+0 ‚Ç¨</div>
          <div style="font-size:12px;color:var(--text-muted)">Entr√©es</div>
        </div>
        <div style="text-align:center;padding:16px;background:rgba(220,38,38,0.1);border-radius:8px">
          <div style="font-size:24px;font-weight:700;color:var(--danger)" id="resume-sorties">-0 ‚Ç¨</div>
          <div style="font-size:12px;color:var(--text-muted)">Sorties</div>
        </div>
        <div style="text-align:center;padding:16px;background:var(--bg-subtle);border-radius:8px">
          <div style="font-size:24px;font-weight:700" id="resume-solde">0 ‚Ç¨</div>
          <div style="font-size:12px;color:var(--text-muted)">Solde</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== OUTILS ==================== -->
  <div class="tab-content" id="tab-outils">
    
    <!-- Comparateur -->
    <div class="tool-card" id="tool-comparateur">
      <div class="tool-header">
        <div class="tool-icon">‚öñÔ∏è</div>
        <div>
          <div class="tool-title">Comparateur de d√©cisions</div>
          <div class="tool-desc">Comparez deux choix financiers</div>
        </div>
        <span class="badge pro" id="badge-comparateur">Essentiel</span>
      </div>
      <div id="comparateur-content">
        <div class="compare-grid">
          <div class="compare-box a">
            <div class="compare-label"><div class="compare-badge a">A</div><input type="text" id="compare-a-nom" placeholder="Nom du choix A" style="border:none;background:transparent;font-weight:600;flex:1"></div>
            <div class="field"><label>Co√ªt mensuel (‚Ç¨)</label><input type="number" id="compare-a-cout" placeholder="0"></div>
            <div class="field mt-sm"><label>Dur√©e (mois)</label><input type="number" id="compare-a-duree" placeholder="12"></div>
          </div>
          <div class="compare-box b">
            <div class="compare-label"><div class="compare-badge b">B</div><input type="text" id="compare-b-nom" placeholder="Nom du choix B" style="border:none;background:transparent;font-weight:600;flex:1"></div>
            <div class="field"><label>Co√ªt mensuel (‚Ç¨)</label><input type="number" id="compare-b-cout" placeholder="0"></div>
            <div class="field mt-sm"><label>Dur√©e (mois)</label><input type="number" id="compare-b-duree" placeholder="12"></div>
          </div>
        </div>
        <div style="text-align:center;margin-top:20px">
          <button class="btn btn-primary" id="btn-comparer">‚öñÔ∏è Comparer</button>
        </div>
        <div class="compare-result" id="compare-result" style="display:none"></div>
      </div>
      <div class="locked-overlay" id="comparateur-locked" style="display:none">
        <div class="locked-icon">üîí</div>
        <div class="locked-title">Plan Essentiel requis</div>
        <a href="tarifs.html" class="btn btn-primary">D√©bloquer</a>
      </div>
    </div>

    <!-- Simulateur -->
    <div class="tool-card" id="tool-simulateur">
      <div class="tool-header">
        <div class="tool-icon">üö®</div>
        <div>
          <div class="tool-title">Simulateur d'impr√©vu</div>
          <div class="tool-desc">Testez la r√©sistance de votre budget</div>
        </div>
        <span class="badge max" id="badge-simulateur">Complet</span>
      </div>
      <div id="simulateur-content">
        <div class="grid-2">
          <div class="field">
            <label>Type d'impr√©vu</label>
            <select id="imprevu-type">
              <option value="reparation">üîß R√©paration voiture</option>
              <option value="sante">üè• Frais m√©dicaux</option>
              <option value="maison">üè† Travaux maison</option>
              <option value="appareil">üì± Remplacement appareil</option>
              <option value="autre">üì¶ Autre</option>
            </select>
          </div>
          <div class="field">
            <label>Montant (‚Ç¨)</label>
            <input type="number" id="imprevu-montant" placeholder="1500">
          </div>
        </div>
        <div class="field mt-md">
          <label>√âtaler sur (mois)</label>
          <input type="number" id="imprevu-mois" value="3" min="1" max="24">
        </div>
        <button class="btn btn-primary mt-lg" style="width:100%" id="btn-simuler">üö® Simuler</button>
        <div id="simulateur-result" style="display:none;margin-top:20px"></div>
      </div>
      <div class="locked-overlay" id="simulateur-locked" style="display:none">
        <div class="locked-icon">üîí</div>
        <div class="locked-title">Plan Complet requis</div>
        <a href="tarifs.html" class="btn btn-primary">D√©bloquer</a>
      </div>
    </div>

    <!-- Pr√©l√®vements -->
    <div class="tool-card" id="tool-prelevements">
      <div class="tool-header">
        <div class="tool-icon">üìÖ</div>
        <div>
          <div class="tool-title">Pr√©l√®vements √† venir</div>
          <div class="tool-desc">Rappels de vos d√©penses r√©currentes</div>
        </div>
        <span class="badge pro" id="badge-prelevements">Essentiel</span>
      </div>
      <div id="prelevements-content">
        <div id="prelevements-list">
          <div class="empty-state" style="padding:24px">
            <p>Aucun pr√©l√®vement configur√©</p>
          </div>
        </div>
        <button class="btn btn-secondary mt-md" id="btn-add-prelevement">+ Ajouter un pr√©l√®vement</button>
        <div class="card mt-lg" style="background:var(--bg-subtle)">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" id="rappel-email-actif" style="width:18px;height:18px">
            <span>Recevoir un rappel email</span>
            <span class="badge pro" style="margin-left:auto">Complet</span>
          </label>
          <p class="hint">Un email 3 jours avant chaque pr√©l√®vement</p>
        </div>
      </div>
      <div class="locked-overlay" id="prelevements-locked" style="display:none">
        <div class="locked-icon">üîí</div>
        <div class="locked-title">Plan Essentiel requis</div>
        <a href="tarifs.html" class="btn btn-primary">D√©bloquer</a>
      </div>
    </div>

    <!-- Gestion abonnement -->
    <div class="tool-card">
      <div class="tool-header">
        <div class="tool-icon">‚≠ê</div>
        <div>
          <div class="tool-title">G√©rer mon abonnement</div>
          <div class="tool-desc">Modifier ou annuler votre plan</div>
        </div>
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <a href="tarifs.html" class="btn btn-primary">Voir les offres</a>
        <button class="btn btn-ghost" id="btn-customer-portal">Portail client Stripe</button>
      </div>
    </div>
  </div>
</main>

<!-- ==================== MODALS ==================== -->

<!-- Modal Mouvement -->
<div class="modal" id="modal-movement">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Ajouter un mouvement</h3>
      <button class="modal-close" data-close="modal-movement">√ó</button>
    </div>
    <div class="modal-body">
      <div class="type-selector" id="movement-type-selector">
        <div class="type-option" data-type="revenu">
          <div class="type-option-icon">üíµ</div>
          <div class="type-option-label">Revenu</div>
        </div>
        <div class="type-option" data-type="epargne">
          <div class="type-option-icon">üíé</div>
          <div class="type-option-label">√âpargne</div>
        </div>
        <div class="type-option" data-type="essentiel">
          <div class="type-option-icon">üè†</div>
          <div class="type-option-label">Essentielle</div>
        </div>
        <div class="type-option" data-type="non-essentiel">
          <div class="type-option-icon">üõçÔ∏è</div>
          <div class="type-option-label">Non essentielle</div>
        </div>
        <div class="type-option" data-type="imprevu">
          <div class="type-option-icon">üö®</div>
          <div class="type-option-label">Impr√©vu</div>
        </div>
      </div>
      <div class="field">
        <label>Description</label>
        <input type="text" id="movement-desc" placeholder="Ex: Salaire, Loyer, Netflix...">
      </div>
      <div class="field mt-md">
        <label>Montant (‚Ç¨)</label>
        <input type="number" id="movement-amount" placeholder="0" step="0.01">
      </div>
      <div class="field mt-md">
        <label>Date</label>
        <input type="date" id="movement-date">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close="modal-movement">Annuler</button>
      <button class="btn btn-primary" id="btn-save-movement">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Modal √âpargne -->
<div class="modal" id="modal-epargne">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Objectif √©pargne</h3>
      <button class="modal-close" data-close="modal-epargne">√ó</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label>Nom de l'objectif</label>
        <input type="text" id="epargne-nom" placeholder="Ex: Voiture, Vacances...">
      </div>
      <div class="field mt-md">
        <label>Montant objectif (‚Ç¨)</label>
        <input type="number" id="epargne-objectif" placeholder="10000">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close="modal-epargne">Annuler</button>
      <button class="btn btn-primary" id="btn-save-epargne">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Modal Pr√©l√®vement -->
<div class="modal" id="modal-prelevement">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Ajouter un pr√©l√®vement</h3>
      <button class="modal-close" data-close="modal-prelevement">√ó</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label>Nom</label>
        <input type="text" id="prelevement-nom" placeholder="Ex: Netflix, EDF...">
      </div>
      <div class="field mt-md">
        <label>Montant (‚Ç¨)</label>
        <input type="number" id="prelevement-montant" placeholder="15.99" step="0.01">
      </div>
      <div class="field mt-md">
        <label>Jour du mois</label>
        <input type="number" id="prelevement-jour" placeholder="15" min="1" max="31">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close="modal-prelevement">Annuler</button>
      <button class="btn btn-primary" id="btn-save-prelevement">Ajouter</button>
    </div>
  </div>
</div>

<!-- Chat Widget -->
<button class="chat-btn" id="chat-btn">üí¨</button>
<div class="chat-window" id="chat-window">
  <div class="chat-header">
    <div class="chat-header-info">
      <span>ü§ñ</span>
      <h4>Assistant Budget</h4>
    </div>
    <button class="chat-close" id="chat-close">√ó</button>
  </div>
  <div id="chat-content">
    <!-- Contenu dynamique -->
  </div>
</div>

<script src="assets/nav-auth.js"></script>
<script>
// ============================================
// DASHBOARD FINAL - O√π part mon argent ?
// ============================================

(function() {
  'use strict';

  // === CONFIGURATION ===
  var PLANS = {
    free: { name: 'Gratuit', icon: '‚≠ê', desc: 'Fonctionnalit√©s de base', features: [] },
    essential: { name: 'Essentiel', icon: 'üíé', desc: 'Outils de gestion', features: ['comparateur', 'prelevements'] },
    complete: { name: 'Complet', icon: 'üëë', desc: 'Toutes les fonctionnalit√©s', features: ['comparateur', 'prelevements', 'simulateur', 'chat', 'rappel-email'] }
  };

  var MISSIONS = {
    free: [
      { id: 'add-revenu', text: 'Ajouter vos revenus du mois', points: 10 },
      { id: 'add-3-mouvements', text: 'Enregistrer 3 mouvements', points: 15 },
      { id: 'check-score', text: 'Consulter votre score', points: 5 }
    ],
    essential: [
      { id: 'add-revenu', text: 'Ajouter vos revenus du mois', points: 10 },
      { id: 'add-5-mouvements', text: 'Enregistrer 5 mouvements', points: 20 },
      { id: 'add-epargne', text: '√âpargner ce mois', points: 25 },
      { id: 'use-comparateur', text: 'Utiliser le comparateur', points: 15 },
      { id: 'add-prelevement', text: 'Configurer un pr√©l√®vement', points: 10 }
    ],
    complete: [
      { id: 'add-revenu', text: 'Ajouter vos revenus du mois', points: 10 },
      { id: 'add-5-mouvements', text: 'Enregistrer 5 mouvements', points: 20 },
      { id: 'add-epargne', text: '√âpargner ce mois', points: 25 },
      { id: 'use-comparateur', text: 'Utiliser le comparateur', points: 15 },
      { id: 'use-simulateur', text: 'Tester le simulateur', points: 15 },
      { id: 'chat-assistant', text: 'Poser une question au chat', points: 15 }
    ]
  };

  var MOVEMENT_ICONS = {
    revenu: 'üíµ',
    epargne: 'üíé',
    essentiel: 'üè†',
    'non-essentiel': 'üõçÔ∏è',
    imprevu: 'üö®'
  };

  var MOVEMENT_LABELS = {
    revenu: 'Revenu',
    epargne: '√âpargne',
    essentiel: 'D√©pense essentielle',
    'non-essentiel': 'D√©pense non essentielle',
    imprevu: 'Impr√©vu'
  };

  // === UTILITAIRES ===
  function formatMoney(n) {
    return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0);
  }

  function formatDate(d) {
    return new Date(d).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
  }

  function getData(key, def) {
    try { var v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } 
    catch(e) { return def; }
  }

  function setData(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }

  function getPlan() {
    return getData('plan', 'free');
  }

  function hasFeature(feature) {
    var plan = getPlan();
    var config = PLANS[plan] || PLANS.free;
    return config.features.indexOf(feature) !== -1;
  }

  function getCurrentMonth() {
    var d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
  }

  function getMovementsThisMonth() {
    var all = getData('movements', []);
    var month = getCurrentMonth();
    return all.filter(function(m) { return m.date && m.date.startsWith(month); });
  }

  // === CALCULS DEPUIS LE JOURNAL ===
  function calculateStats() {
    var movements = getMovementsThisMonth();
    var stats = {
      revenus: 0,
      essentielles: 0,
      nonEssentielles: 0,
      epargne: 0,
      imprevu: 0
    };

    movements.forEach(function(m) {
      var amount = Math.abs(m.amount || 0);
      switch(m.type) {
        case 'revenu': stats.revenus += amount; break;
        case 'essentiel': stats.essentielles += amount; break;
        case 'non-essentiel': stats.nonEssentielles += amount; break;
        case 'epargne': stats.epargne += amount; break;
        case 'imprevu': stats.imprevu += amount; break;
      }
    });

    stats.totalDepenses = stats.essentielles + stats.nonEssentielles + stats.imprevu;
    stats.resteAVivre = stats.revenus - stats.totalDepenses - stats.epargne;
    
    return stats;
  }

  function calculateScore(stats) {
    if (stats.revenus <= 0) return 0;
    
    var ratio = stats.resteAVivre / stats.revenus;
    var epargneRatio = stats.epargne / stats.revenus;
    
    var score = 0;
    
    // Base: ratio reste √† vivre (max 50 pts)
    if (ratio >= 0.20) score += 50;
    else if (ratio >= 0.10) score += 35;
    else if (ratio >= 0) score += 20;
    else score += 0;
    
    // Bonus √©pargne (max 30 pts)
    if (epargneRatio >= 0.20) score += 30;
    else if (epargneRatio >= 0.10) score += 20;
    else if (epargneRatio > 0) score += 10;
    
    // Bonus: pas d'impr√©vu (10 pts)
    if (stats.imprevu === 0) score += 10;
    
    // Bonus: d√©penses non-ess < 30% (10 pts)
    if (stats.revenus > 0 && stats.nonEssentielles / stats.revenus < 0.30) score += 10;
    
    return Math.min(100, Math.max(0, score));
  }

  function getScoreInfo(score) {
    if (score >= 70) return { label: 'Excellente sant√©', class: 'success' };
    if (score >= 50) return { label: 'Bonne gestion', class: 'success' };
    if (score >= 30) return { label: '√Ä am√©liorer', class: 'warning' };
    return { label: 'Attention requise', class: 'danger' };
  }

  // === RENDU ===
  function renderPlanBanner() {
    var plan = getPlan();
    var config = PLANS[plan] || PLANS.free;
    
    document.getElementById('plan-icon').textContent = config.icon;
    document.getElementById('plan-name').textContent = 'Plan ' + config.name;
    document.getElementById('plan-desc').textContent = config.desc;
    
    var btn = document.getElementById('plan-btn');
    if (plan === 'complete') {
      btn.textContent = 'G√©rer';
    } else {
      btn.textContent = 'Am√©liorer';
    }
  }

  function renderStats() {
    var stats = calculateStats();
    
    document.getElementById('stat-revenus').textContent = formatMoney(stats.revenus);
    document.getElementById('stat-essentielles').textContent = formatMoney(stats.essentielles);
    document.getElementById('stat-non-essentielles').textContent = formatMoney(stats.nonEssentielles);
    
    var resteEl = document.getElementById('stat-reste');
    resteEl.textContent = formatMoney(stats.resteAVivre);
    resteEl.className = 'stat-value ' + (stats.resteAVivre >= 0 ? 'positive' : 'negative');
    
    // Score
    var score = calculateScore(stats);
    var scoreInfo = getScoreInfo(score);
    
    document.getElementById('score-number').textContent = score;
    
    var circumference = 2 * Math.PI * 60;
    var offset = circumference - (score / 100) * circumference;
    document.getElementById('score-circle').style.strokeDashoffset = offset;
    
    var badge = document.getElementById('score-badge');
    badge.textContent = scoreInfo.label;
    badge.className = 'badge ' + scoreInfo.class;
    
    // R√©sum√© mouvements
    var entrees = stats.revenus;
    var sorties = stats.totalDepenses + stats.epargne;
    document.getElementById('resume-entrees').textContent = '+' + formatMoney(entrees);
    document.getElementById('resume-sorties').textContent = '-' + formatMoney(sorties);
    
    var solde = entrees - sorties;
    var soldeEl = document.getElementById('resume-solde');
    soldeEl.textContent = formatMoney(solde);
    soldeEl.style.color = solde >= 0 ? 'var(--accent)' : 'var(--danger)';
  }

  function renderEpargne() {
    var stats = calculateStats();
    var objectif = getData('epargneObjectif', { nom: '', montant: 0 });
    var totalEpargne = getData('totalEpargne', 0) + stats.epargne;
    
    if (objectif.nom) {
      document.getElementById('epargne-objectif-text').textContent = objectif.nom + ' - ' + formatMoney(objectif.montant);
    }
    
    var pct = objectif.montant > 0 ? Math.round((totalEpargne / objectif.montant) * 100) : 0;
    var restant = Math.max(0, objectif.montant - totalEpargne);
    var conseille = restant > 0 ? Math.ceil(restant / 12) : 0;
    
    document.getElementById('epargne-total').textContent = formatMoney(totalEpargne);
    document.getElementById('epargne-mois').textContent = formatMoney(stats.epargne);
    document.getElementById('epargne-restant').textContent = formatMoney(restant);
    document.getElementById('epargne-conseille').textContent = formatMoney(conseille);
    document.getElementById('epargne-progress').style.width = Math.min(100, pct) + '%';
  }

  function renderMissions() {
    var plan = getPlan();
    var missions = MISSIONS[plan] || MISSIONS.free;
    var completed = getData('missionsCompleted', {});
    var movements = getMovementsThisMonth();
    var stats = calculateStats();
    
    // Auto-check missions
    if (stats.revenus > 0) completed['add-revenu'] = true;
    if (movements.length >= 3) completed['add-3-mouvements'] = true;
    if (movements.length >= 5) completed['add-5-mouvements'] = true;
    if (stats.epargne > 0) completed['add-epargne'] = true;
    completed['check-score'] = true; // Toujours compl√©t√© quand on voit le dashboard
    
    setData('missionsCompleted', completed);
    
    var html = '';
    var completedCount = 0;
    
    missions.forEach(function(m) {
      var done = completed[m.id];
      if (done) completedCount++;
      
      html += '<div class="mission' + (done ? ' completed' : '') + '">';
      html += '<div class="mission-check">' + (done ? '‚úì' : '') + '</div>';
      html += '<div class="mission-text">' + m.text + '</div>';
      html += '<div class="mission-points">+' + m.points + ' pts</div>';
      html += '</div>';
    });
    
    document.getElementById('missions-list').innerHTML = html;
    document.getElementById('missions-progress').textContent = completedCount + '/' + missions.length + ' compl√©t√©es';
  }

  function renderMovements(filter) {
    filter = filter || 'all';
    var movements = getMovementsThisMonth();
    
    if (filter !== 'all') {
      movements = movements.filter(function(m) { return m.type === filter; });
    }
    
    // Trier par date d√©croissante
    movements.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
    
    var container = document.getElementById('movement-list');
    
    if (movements.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>Aucun mouvement' + (filter !== 'all' ? ' de ce type' : '') + '</p></div>';
      return;
    }
    
    var html = '';
    movements.forEach(function(m, i) {
      var isPositive = m.type === 'revenu';
      html += '<div class="movement">';
      html += '<div class="movement-icon ' + m.type + '">' + MOVEMENT_ICONS[m.type] + '</div>';
      html += '<div class="movement-info">';
      html += '<div class="movement-title">' + (m.desc || MOVEMENT_LABELS[m.type]) + '</div>';
      html += '<div class="movement-meta">' + MOVEMENT_LABELS[m.type] + ' ‚Ä¢ ' + formatDate(m.date) + '</div>';
      html += '</div>';
      html += '<div class="movement-amount ' + (isPositive ? 'positive' : 'negative') + '">' + (isPositive ? '+' : '-') + formatMoney(Math.abs(m.amount)) + '</div>';
      html += '<button class="movement-delete" data-index="' + m.id + '">üóëÔ∏è</button>';
      html += '</div>';
    });
    
    container.innerHTML = html;
    
    // Events suppression
    container.querySelectorAll('.movement-delete').forEach(function(btn) {
      btn.addEventListener('click', function() {
        if (confirm('Supprimer ce mouvement ?')) {
          deleteMovement(this.dataset.index);
        }
      });
    });
  }

  function renderPrelevements() {
    var prelevements = getData('prelevements', []);
    var container = document.getElementById('prelevements-list');
    
    if (prelevements.length === 0) {
      container.innerHTML = '<div class="empty-state" style="padding:24px"><p>Aucun pr√©l√®vement configur√©</p></div>';
      return;
    }
    
    // Trier par jour
    prelevements.sort(function(a, b) { return a.jour - b.jour; });
    
    var html = '';
    var mois = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];
    var now = new Date();
    
    prelevements.forEach(function(p, i) {
      html += '<div class="prelevement">';
      html += '<div class="prelevement-date"><div class="prelevement-day">' + p.jour + '</div><div class="prelevement-month">' + mois[now.getMonth()] + '</div></div>';
      html += '<div class="prelevement-info"><div class="prelevement-name">' + p.nom + '</div></div>';
      html += '<div class="prelevement-amount">-' + formatMoney(p.montant) + '</div>';
      html += '<button class="movement-delete" data-prelevement="' + i + '">üóëÔ∏è</button>';
      html += '</div>';
    });
    
    container.innerHTML = html;
    
    // Events suppression
    container.querySelectorAll('[data-prelevement]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        if (confirm('Supprimer ce pr√©l√®vement ?')) {
          var index = parseInt(this.dataset.prelevement);
          var list = getData('prelevements', []);
          list.splice(index, 1);
          setData('prelevements', list);
          renderPrelevements();
        }
      });
    });
  }

  function renderToolAccess() {
    var plan = getPlan();
    
    // Comparateur
    var comparateurLocked = !hasFeature('comparateur');
    document.getElementById('tool-comparateur').classList.toggle('locked-tool', comparateurLocked);
    document.getElementById('comparateur-locked').style.display = comparateurLocked ? 'flex' : 'none';
    document.getElementById('badge-comparateur').style.display = comparateurLocked ? '' : 'none';
    
    // Simulateur
    var simulateurLocked = !hasFeature('simulateur');
    document.getElementById('tool-simulateur').classList.toggle('locked-tool', simulateurLocked);
    document.getElementById('simulateur-locked').style.display = simulateurLocked ? 'flex' : 'none';
    document.getElementById('badge-simulateur').style.display = simulateurLocked ? '' : 'none';
    
    // Pr√©l√®vements
    var prelevementsLocked = !hasFeature('prelevements');
    document.getElementById('tool-prelevements').classList.toggle('locked-tool', prelevementsLocked);
    document.getElementById('prelevements-locked').style.display = prelevementsLocked ? 'flex' : 'none';
    document.getElementById('badge-prelevements').style.display = prelevementsLocked ? '' : 'none';
    
    // Rappel email
    var emailCheckbox = document.getElementById('rappel-email-actif');
    emailCheckbox.disabled = !hasFeature('rappel-email');
  }

  function renderChat() {
    var container = document.getElementById('chat-content');
    
    if (!hasFeature('chat')) {
      container.innerHTML = '<div class="chat-locked"><div style="font-size:48px;margin-bottom:16px">üîí</div><div style="font-size:18px;font-weight:600;margin-bottom:8px">Fonctionnalit√© Premium</div><p style="color:var(--text-muted);margin-bottom:20px">L\'assistant IA est disponible avec le plan Complet.</p><a href="tarifs.html" class="btn btn-primary">D√©bloquer</a></div>';
      return;
    }
    
    container.innerHTML = '<div class="chat-messages" id="chat-messages"></div><div class="chat-input-area"><input type="text" class="chat-input" id="chat-input" placeholder="Posez votre question..."><button class="chat-send" id="chat-send">‚û§</button></div>';
    
    // Charger historique
    var history = getData('chatHistory', []);
    var messagesEl = document.getElementById('chat-messages');
    
    if (history.length === 0) {
      messagesEl.innerHTML = '<div class="chat-message bot">Bonjour ! Je suis votre assistant budget. Comment puis-je vous aider ?</div>';
    } else {
      var html = '';
      history.forEach(function(m) {
        html += '<div class="chat-message ' + m.type + '">' + m.text + '</div>';
      });
      messagesEl.innerHTML = html;
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    
    // Events
    var input = document.getElementById('chat-input');
    var sendBtn = document.getElementById('chat-send');
    
    function sendMessage() {
      var text = input.value.trim();
      if (!text) return;
      
      // Ajouter message user
      var history = getData('chatHistory', []);
      history.push({ type: 'user', text: text });
      
      // R√©ponse bot
      var response = getBotResponse(text);
      history.push({ type: 'bot', text: response });
      
      if (history.length > 50) history = history.slice(-50);
      setData('chatHistory', history);
      
      // Marquer mission
      var completed = getData('missionsCompleted', {});
      completed['chat-assistant'] = true;
      setData('missionsCompleted', completed);
      
      // Render
      var messagesEl = document.getElementById('chat-messages');
      messagesEl.innerHTML += '<div class="chat-message user">' + text + '</div>';
      messagesEl.innerHTML += '<div class="chat-message bot">' + response + '</div>';
      messagesEl.scrollTop = messagesEl.scrollHeight;
      
      input.value = '';
      renderMissions();
    }
    
    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keypress', function(e) { if (e.key === 'Enter') sendMessage(); });
  }

  function getBotResponse(text) {
    var t = text.toLowerCase();
    var stats = calculateStats();
    
    if (t.match(/score|sant√©|sante/)) {
      var score = calculateScore(stats);
      return 'Votre score actuel est de ' + score + '/100. ' + getScoreInfo(score).label + '.';
    }
    if (t.match(/reste|vivre|disponible/)) {
      return 'Votre reste √† vivre ce mois est de ' + formatMoney(stats.resteAVivre) + '.';
    }
    if (t.match(/√©pargne|epargne|√©conom/)) {
      return 'Vous avez √©pargn√© ' + formatMoney(stats.epargne) + ' ce mois. L\'id√©al est d\'√©pargner 10-20% de vos revenus.';
    }
    if (t.match(/conseil|aide|am√©liorer/)) {
      if (stats.resteAVivre < 0) {
        return 'Votre budget est en d√©ficit. Priorit√© : r√©duire les d√©penses non essentielles (' + formatMoney(stats.nonEssentielles) + ' ce mois).';
      }
      if (stats.epargne === 0) {
        return 'Conseil : essayez d\'√©pargner m√™me un petit montant chaque mois pour cr√©er l\'habitude.';
      }
      return 'Vous g√©rez bien ! Continuez √† suivre vos mouvements et √† √©pargner r√©guli√®rement.';
    }
    if (t.match(/bonjour|salut|hello/)) {
      return 'Bonjour ! Comment puis-je vous aider avec votre budget ?';
    }
    
    return 'Je peux vous aider avec : votre score, reste √† vivre, √©pargne, ou vous donner des conseils. Que souhaitez-vous savoir ?';
  }

  // === ACTIONS ===
  function deleteMovement(id) {
    var movements = getData('movements', []);
    movements = movements.filter(function(m) { return m.id !== id; });
    setData('movements', movements);
    renderAll();
  }

  function saveMovement() {
    var typeEl = document.querySelector('.type-option.selected');
    if (!typeEl) { alert('S√©lectionnez un type'); return; }
    
    var type = typeEl.dataset.type;
    var desc = document.getElementById('movement-desc').value.trim();
    var amount = parseFloat(document.getElementById('movement-amount').value) || 0;
    var date = document.getElementById('movement-date').value;
    
    if (amount <= 0) { alert('Entrez un montant valide'); return; }
    if (!date) { alert('S√©lectionnez une date'); return; }
    
    var movements = getData('movements', []);
    movements.push({
      id: 'mv_' + Date.now(),
      type: type,
      desc: desc || MOVEMENT_LABELS[type],
      amount: amount,
      date: date
    });
    setData('movements', movements);
    
    closeModal('modal-movement');
    resetMovementForm();
    renderAll();
  }

  function resetMovementForm() {
    document.querySelectorAll('.type-option').forEach(function(el) { el.classList.remove('selected'); });
    document.getElementById('movement-desc').value = '';
    document.getElementById('movement-amount').value = '';
    document.getElementById('movement-date').value = new Date().toISOString().split('T')[0];
  }

  function saveEpargne() {
    var nom = document.getElementById('epargne-nom').value.trim();
    var montant = parseFloat(document.getElementById('epargne-objectif').value) || 0;
    
    setData('epargneObjectif', { nom: nom, montant: montant });
    closeModal('modal-epargne');
    renderEpargne();
  }

  function savePrelevement() {
    var nom = document.getElementById('prelevement-nom').value.trim();
    var montant = parseFloat(document.getElementById('prelevement-montant').value) || 0;
    var jour = parseInt(document.getElementById('prelevement-jour').value) || 1;
    
    if (!nom || montant <= 0) { alert('Remplissez tous les champs'); return; }
    
    var list = getData('prelevements', []);
    list.push({ nom: nom, montant: montant, jour: jour });
    setData('prelevements', list);
    
    // Marquer mission
    var completed = getData('missionsCompleted', {});
    completed['add-prelevement'] = true;
    setData('missionsCompleted', completed);
    
    closeModal('modal-prelevement');
    document.getElementById('prelevement-nom').value = '';
    document.getElementById('prelevement-montant').value = '';
    document.getElementById('prelevement-jour').value = '';
    
    renderPrelevements();
    renderMissions();
  }

  function comparer() {
    var nomA = document.getElementById('compare-a-nom').value || 'Choix A';
    var coutA = parseFloat(document.getElementById('compare-a-cout').value) || 0;
    var dureeA = parseInt(document.getElementById('compare-a-duree').value) || 1;
    var nomB = document.getElementById('compare-b-nom').value || 'Choix B';
    var coutB = parseFloat(document.getElementById('compare-b-cout').value) || 0;
    var dureeB = parseInt(document.getElementById('compare-b-duree').value) || 1;
    
    var totalA = coutA * dureeA;
    var totalB = coutB * dureeB;
    var diff = Math.abs(totalA - totalB);
    var winner = totalA < totalB ? nomA : (totalB < totalA ? nomB : null);
    
    var html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">';
    html += '<div style="text-align:center"><div style="font-size:12px;color:var(--text-muted)">' + nomA + '</div><div style="font-size:24px;font-weight:700;color:var(--accent)">' + formatMoney(totalA) + '</div></div>';
    html += '<div style="text-align:center"><div style="font-size:12px;color:var(--text-muted)">' + nomB + '</div><div style="font-size:24px;font-weight:700;color:#3b82f6">' + formatMoney(totalB) + '</div></div>';
    html += '</div>';
    html += '<div style="text-align:center;padding:16px;background:#fff;border-radius:8px">';
    html += '<div style="font-size:12px;color:var(--text-muted)">Diff√©rence</div>';
    html += '<div style="font-size:28px;font-weight:700">' + formatMoney(diff) + '</div>';
    if (winner) {
      html += '<div style="color:var(--accent);font-weight:600;margin-top:8px">‚úÖ ' + winner + ' est plus √©conomique</div>';
    }
    html += '</div>';
    
    document.getElementById('compare-result').innerHTML = html;
    document.getElementById('compare-result').style.display = 'block';
    
    // Marquer mission
    var completed = getData('missionsCompleted', {});
    completed['use-comparateur'] = true;
    setData('missionsCompleted', completed);
    renderMissions();
  }

  function simuler() {
    var stats = calculateStats();
    if (stats.revenus <= 0) { alert('Ajoutez d\'abord vos revenus'); return; }
    
    var montant = parseFloat(document.getElementById('imprevu-montant').value) || 0;
    var mois = parseInt(document.getElementById('imprevu-mois').value) || 1;
    
    if (montant <= 0) { alert('Entrez un montant'); return; }
    
    var coutMensuel = montant / mois;
    var nouveauReste = stats.resteAVivre - coutMensuel;
    
    var status, icon, title, message;
    if (nouveauReste >= stats.resteAVivre * 0.5) {
      status = 'success'; icon = '‚úÖ'; title = 'Absorbable';
      message = 'Votre budget peut g√©rer cet impr√©vu.';
    } else if (nouveauReste >= 0) {
      status = 'warning'; icon = '‚ö†Ô∏è'; title = 'Tendu';
      message = 'Budget serr√© mais faisable.';
    } else {
      status = 'danger'; icon = '‚ùå'; title = 'Critique';
      message = 'Cet impr√©vu d√©passe votre capacit√©.';
    }
    
    var html = '<div style="padding:20px;background:' + (status === 'success' ? 'var(--accent-subtle)' : status === 'warning' ? 'rgba(245,158,11,0.1)' : 'rgba(220,38,38,0.1)') + ';border-radius:12px">';
    html += '<div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">';
    html += '<span style="font-size:40px">' + icon + '</span>';
    html += '<div><div style="font-size:18px;font-weight:700">' + title + '</div><div style="color:var(--text-muted)">' + message + '</div></div>';
    html += '</div>';
    html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">';
    html += '<div style="text-align:center;padding:12px;background:#fff;border-radius:8px"><div style="font-size:11px;color:var(--text-muted)">Reste actuel</div><div style="font-size:18px;font-weight:700">' + formatMoney(stats.resteAVivre) + '</div></div>';
    html += '<div style="text-align:center;padding:12px;background:#fff;border-radius:8px"><div style="font-size:11px;color:var(--text-muted)">Co√ªt/mois</div><div style="font-size:18px;font-weight:700;color:var(--danger)">-' + formatMoney(coutMensuel) + '</div></div>';
    html += '<div style="text-align:center;padding:12px;background:#fff;border-radius:8px"><div style="font-size:11px;color:var(--text-muted)">Nouveau reste</div><div style="font-size:18px;font-weight:700;color:' + (nouveauReste >= 0 ? 'var(--accent)' : 'var(--danger)') + '">' + formatMoney(nouveauReste) + '</div></div>';
    html += '</div></div>';
    
    document.getElementById('simulateur-result').innerHTML = html;
    document.getElementById('simulateur-result').style.display = 'block';
    
    // Marquer mission
    var completed = getData('missionsCompleted', {});
    completed['use-simulateur'] = true;
    setData('missionsCompleted', completed);
    renderMissions();
  }

  // === MODALS ===
  function openModal(id) { document.getElementById(id).classList.add('open'); }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }

  // === RENDER ALL ===
  function renderAll() {
    renderPlanBanner();
    renderStats();
    renderEpargne();
    renderMissions();
    renderMovements();
    renderPrelevements();
    renderToolAccess();
    renderChat();
  }

  // === INIT ===
  function init() {
    // V√©rifier auth
    try {
      var session = JSON.parse(localStorage.getItem('auth_session_v1'));
      if (!session || !session.email) {
        window.location.replace('login.html');
        return;
      }
    } catch(e) {
      window.location.replace('login.html');
      return;
    }

    // Date par d√©faut
    document.getElementById('movement-date').value = new Date().toISOString().split('T')[0];

    // Render
    renderAll();

    // === EVENT LISTENERS ===
    
    // Tabs
    document.querySelectorAll('.tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        this.classList.add('active');
        document.getElementById('tab-' + this.dataset.tab).classList.add('active');
      });
    });

    // Filters
    document.querySelectorAll('.filter-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
        this.classList.add('active');
        renderMovements(this.dataset.filter);
      });
    });

    // Type selector
    document.querySelectorAll('.type-option').forEach(function(opt) {
      opt.addEventListener('click', function() {
        document.querySelectorAll('.type-option').forEach(function(o) { o.classList.remove('selected'); });
        this.classList.add('selected');
      });
    });

    // Buttons
    document.getElementById('btn-add-movement').addEventListener('click', function() { openModal('modal-movement'); });
    document.getElementById('btn-add-first').addEventListener('click', function() { openModal('modal-movement'); });
    document.getElementById('btn-save-movement').addEventListener('click', saveMovement);
    document.getElementById('btn-edit-epargne').addEventListener('click', function() { openModal('modal-epargne'); });
    document.getElementById('btn-save-epargne').addEventListener('click', saveEpargne);
    document.getElementById('btn-add-prelevement').addEventListener('click', function() { openModal('modal-prelevement'); });
    document.getElementById('btn-save-prelevement').addEventListener('click', savePrelevement);
    document.getElementById('btn-comparer').addEventListener('click', comparer);
    document.getElementById('btn-simuler').addEventListener('click', simuler);
    
    // Customer Portal (placeholder)
    document.getElementById('btn-customer-portal').addEventListener('click', function() {
      alert('Redirection vers Stripe Customer Portal (√† configurer avec Stripe)');
    });

    // Close modals
    document.querySelectorAll('[data-close]').forEach(function(btn) {
      btn.addEventListener('click', function() { closeModal(this.dataset.close); });
    });
    document.querySelectorAll('.modal').forEach(function(modal) {
      modal.addEventListener('click', function(e) { if (e.target === this) closeModal(this.id); });
    });

    // Chat widget
    document.getElementById('chat-btn').addEventListener('click', function() {
      document.getElementById('chat-window').classList.toggle('open');
    });
    document.getElementById('chat-close').addEventListener('click', function() {
      document.getElementById('chat-window').classList.remove('open');
    });

    console.log('Dashboard FINAL initialis√©');
  }

  // Start
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

</body>
</html>